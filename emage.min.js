!function(a){"undefined"!=typeof define&&define.amd?define(["exports"],a.bind(window)):a(window.emage={})}(function(a){var b,c,d;!function(a){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(b,c){return function(){return n.apply(a,v.call(arguments,0).concat([b,c]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(b){if(e(r,b)){var c=r[b];delete r[b],t[b]=!0,m.apply(a,c)}if(!e(q,b)&&!e(t,b))throw new Error("No "+b);return q[b]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(b,c,d,f){var h,k,l,m,n,s,u=[];if(f=f||b,"function"==typeof d){for(c=!c.length&&d.length?["require","exports","module"]:c,n=0;n<c.length;n+=1)if(m=o(c[n],f),k=m.f,"require"===k)u[n]=p.require(b);else if("exports"===k)u[n]=p.exports(b),s=!0;else if("module"===k)h=u[n]=p.module(b);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(b+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=d.apply(q[b],u),b&&(h&&h.exports!==a&&h.exports!==q[b]?q[b]=h.exports:l===a&&s||(q[b]=l))}else b&&(q[b]=d)},b=c=n=function(b,c,d,e,f){return"string"==typeof b?p[b]?p[b](c):j(o(b,c).f):(b.splice||(s=b,c.splice?(b=c,c=d,d=null):b=a),c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},d=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},d.amd={jQuery:!0}}(),d("build/almond",function(){}),function(a){"undefined"!=typeof d&&d.amd?d("qtek",["exports"],a.bind(window)):a(window.qtek={})}(function(a){var b,c,d;!function(a){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(b,c){return function(){return n.apply(a,v.call(arguments,0).concat([b,c]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(b){if(e(r,b)){var c=r[b];delete r[b],t[b]=!0,m.apply(a,c)}if(!e(q,b)&&!e(t,b))throw new Error("No "+b);return q[b]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(b,c,d,f){var h,k,l,m,n,s,u=[];if(f=f||b,"function"==typeof d){for(c=!c.length&&d.length?["require","exports","module"]:c,n=0;n<c.length;n+=1)if(m=o(c[n],f),k=m.f,"require"===k)u[n]=p.require(b);else if("exports"===k)u[n]=p.exports(b),s=!0;else if("module"===k)h=u[n]=p.module(b);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(b+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=d.apply(q[b],u),b&&(h&&h.exports!==a&&h.exports!==q[b]?q[b]=h.exports:l===a&&s||(q[b]=l))}else b&&(q[b]=d)},b=c=n=function(b,c,d,e,f){return"string"==typeof b?p[b]?p[b](c):j(o(b,c).f):(b.splice||(s=b,c.splice?(b=c,c=d,d=null):b=a),c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},d=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},d.amd={jQuery:!0}}(),d("../build/almond",function(){}),d("core/mixin/derive",[],function(){function a(a,b,c){"object"==typeof b&&(c=b,b=null);var d={"instanceof":function(a){for(var b=f;b;){if(b===a)return!0;b=b.__super__}}},e=this,f=function(c){if(e.call(this),_.extend(this,"function"==typeof a?a.call(this):a),_.extend(this,c),this.constructor==f){for(var d=f,g=[b];d.__super__;)d=d.__super__,g.unshift(d.__initialize__);for(var h=0;h<g.length;h++)g[h]&&g[h].call(this)}};return f.__super__=e,f.__initialize__=b,_.extend(f.prototype,e.prototype,d,c),f.prototype.constructor=f,f.derive=e.derive,f}return{derive:a}}),d("core/mixin/notifier",[],function(){return{trigger:function(){if(this.__handlers__){var a=arguments[0],b=Array.prototype.slice.call(arguments,1),c=this.__handlers__[a];if(c)for(var d=0;d<c.length;d+=2){var e=c[d],f=c[d+1];e.apply(f||this,b)}}},on:function(a,b,c){if(a){var d=this.__handlers__||(this.__handlers__={});return d[a]||(d[a]=[]),-1==d[a].indexOf(b)&&(d[a].push(b),d[a].push(c)),b}},off:function(a,b){var c=this.__handlers__||(this.__handlers__={});if(c[a])if(b){var d=c[a],e=d.indexOf(b);e>=0&&d.splice(e,2)}else c[a]=[]},has:function(a,b){return this.__handlers__&&this.__handlers__[a]?b?-1!==this.__handlers__[a].indexOf(b):this.__handlers__[a].length:!1}}}),d("core/cache",[],function(){var a=function(){this._contextId="",this._caches={},this._context={}};return a.prototype={use:function(a,b){if(!this._caches.hasOwnProperty(a)&&(this._caches[a]={},b))for(var c in b)this._caches[a][c]=b[c];this._contextId=a,this._context=this._caches[a]},put:function(a,b){this._context[a]=b},get:function(a){return this._context[a]},dirty:function(a){a=a||"";var b="__dirty__"+a;this.put(b,!0)},dirtyAll:function(a){a=a||"";var b="__dirty__"+a;for(var c in this._caches)this._caches[b]=!0},fresh:function(a){a=a||"";var b="__dirty__"+a;this.put(b,!1)},freshAll:function(a){a=a||"";var b="__dirty__"+a;for(var c in this._caches)this._caches[b]=!1},isDirty:function(a){a=a||"";var b="__dirty__"+a;return this.get(b)||this.miss(b)},clearContext:function(){this._caches[this._contextId]={},this._context={}},"delete":function(a){delete this._context[a]},clearAll:function(){this._caches={}},getContext:function(){return this._context},miss:function(a){return!this._context.hasOwnProperty(a)}},a.prototype.constructor=a,a}),function(a){function b(d){function e(a){return a&&"object"==typeof a&&!td(a)&&Zc.call(a,"__wrapped__")?a:new R(a)}function g(a,b,c){var d=a.length,e=d-b>=c;if(e)for(var f={},g=b-1;++g<d;){var h=Oc(a[g]);(Zc.call(f,h)?f[h]:f[h]=[]).push(a[g])}return function(c){if(e){var d=Oc(c);return Zc.call(f,d)&&Tb(f[d],c)>-1}return Tb(a,c,b)>-1}}function K(a){return a.charCodeAt(0)}function L(a,b){var c=a.index,d=b.index;if(a=a.criteria,b=b.criteria,a!==b){if(a>b||"undefined"==typeof a)return 1;if(b>a||"undefined"==typeof b)return-1}return d>c?-1:1}function M(a,b,c,d){function e(){var d=arguments,j=g?this:b;if(f||(a=b[h]),c.length&&(d=d.length?(d=U(d),i?d.concat(c):c.concat(d)):c),this instanceof e){S.prototype=a.prototype,j=new S,S.prototype=null;var k=a.apply(j,d);return ib(k)?k:j}return a.apply(j,d)}var f=hb(a),g=!c,h=b;if(g){var i=d;c=b}else if(!f){if(!d)throw new Pc;b=a}return e}function N(){for(var a,b={shadowedProps:v,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!vd},c=0;a=arguments[c];c++)for(var d in a)b[d]=a[d];var f=b.args;b.firstArg=/^[^,]+/.exec(f)[0];var g=Jc("hasOwnProperty, isArguments, isArray, isString, keys, lodash, objectTypes","return function("+f+") {\n"+pd(b)+"\n}");return g(Zc,W,td,nb,vd,e,H)}function O(a){return"\\"+I[a]}function P(a){return xd[a]}function Q(a){return"function"!=typeof a.toString&&"string"==typeof(a+"")}function R(a){this.__wrapped__=a}function S(){}function T(a){var b=!1;if(!a||bd.call(a)!=D||!od.argsClass&&W(a))return b;var c=a.constructor;return(hb(c)?c instanceof c:od.nodeClass||!Q(a))?od.ownLast?(Bd(a,function(a,c,d){return b=Zc.call(d,c),!1}),b===!0):(Bd(a,function(a,c){b=c}),b===!1||Zc.call(a,b)):b}function U(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);for(var d=-1,e=c-b||0,f=Gc(0>e?0:e);++d<e;)f[d]=a[b+d];return f}function V(a){return yd[a]}function W(a){return bd.call(a)==x}function X(a,b,d,f,g,h){var i=a;if("function"==typeof b&&(f=d,d=b,b=!1),"function"==typeof d){if(d="undefined"==typeof f?d:e.createCallback(d,f,1),i=d(i),"undefined"!=typeof i)return i;i=a}var j=ib(i);if(j){var k=bd.call(i);if(!G[k]||!od.nodeClass&&Q(i))return i;var l=td(i)}if(!j||!b)return j?l?U(i):zd({},i):i;var m=nd[k];switch(k){case z:case A:return new m(+i);case C:case F:return new m(i);case E:return m(i.source,o.exec(i))}g||(g=[]),h||(h=[]);for(var n=g.length;n--;)if(g[n]==a)return h[n];return i=l?m(i.length):{},l&&(Zc.call(a,"index")&&(i.index=a.index),Zc.call(a,"input")&&(i.input=a.input)),g.push(a),h.push(i),(l?Ab:Cd)(a,function(a,e){i[e]=X(a,b,d,c,g,h)}),i}function Y(a,b,c){return X(a,!0,b,c)}function Z(a,b,c){var d;return b=e.createCallback(b,c),Cd(a,function(a,c,e){return b(a,c,e)?(d=c,!1):void 0}),d}function $(a){var b=[];return Bd(a,function(a,c){hb(a)&&b.push(c)}),b.sort()}function _(a,b){return a?Zc.call(a,b):!1}function ab(a){for(var b=-1,c=vd(a),d=c.length,e={};++b<d;){var f=c[b];e[a[f]]=f}return e}function bb(a){return a===!0||a===!1||bd.call(a)==z}function cb(a){return a instanceof Ic||bd.call(a)==A}function db(a){return a?1===a.nodeType:!1}function eb(a){var b=!0;if(!a)return b;var c=bd.call(a),d=a.length;return c==y||c==F||(od.argsClass?c==x:W(a))||c==D&&"number"==typeof d&&hb(a.splice)?!d:(Cd(a,function(){return b=!1}),b)}function fb(a,b,c,d,f,g){var h=c===i;if(c&&!h){c="undefined"==typeof d?c:e.createCallback(c,d,2);var j=c(a,b);if("undefined"!=typeof j)return!!j}if(a===b)return 0!==a||1/a==1/b;var k=typeof a,l=typeof b;if(a===a&&(!a||"function"!=k&&"object"!=k)&&(!b||"function"!=l&&"object"!=l))return!1;if(null==a||null==b)return a===b;var m=bd.call(a),n=bd.call(b);if(m==x&&(m=D),n==x&&(n=D),m!=n)return!1;switch(m){case z:case A:return+a==+b;case C:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case E:case F:return a==Oc(b)}var o=m==y;if(!o){if(Zc.call(a,"__wrapped__ ")||Zc.call(b,"__wrapped__"))return fb(a.__wrapped__||a,b.__wrapped__||b,c,d,f,g);if(m!=D||!od.nodeClass&&(Q(a)||Q(b)))return!1;var p=!od.argsObject&&W(a)?Mc:a.constructor,q=!od.argsObject&&W(b)?Mc:b.constructor;if(p!=q&&!(hb(p)&&p instanceof p&&hb(q)&&q instanceof q))return!1}f||(f=[]),g||(g=[]);for(var r=f.length;r--;)if(f[r]==a)return g[r]==b;var s=0;if(j=!0,f.push(a),g.push(b),o){if(r=a.length,s=b.length,j=s==a.length,!j&&!h)return j;for(;s--;){var t=r,u=b[s];if(h)for(;t--&&!(j=fb(a[t],u,c,d,f,g)););else if(!(j=fb(a[s],u,c,d,f,g)))break}return j}return Bd(b,function(b,e,h){return Zc.call(h,e)?(s++,j=Zc.call(a,e)&&fb(a[e],b,c,d,f,g)):void 0}),j&&!h&&Bd(a,function(a,b,c){return Zc.call(c,b)?j=--s>-1:void 0}),j}function gb(a){return ed(a)&&!fd(parseFloat(a))}function hb(a){return"function"==typeof a}function ib(a){return a?H[typeof a]:!1}function jb(a){return lb(a)&&a!=+a}function kb(a){return null===a}function lb(a){return"number"==typeof a||bd.call(a)==C}function mb(a){return a instanceof Nc||bd.call(a)==E}function nb(a){return"string"==typeof a||bd.call(a)==F}function ob(a){return"undefined"==typeof a}function pb(a,b,c){var d=arguments,f=0,g=2;if(!ib(a))return a;if(c===i)var h=d[3],j=d[4],k=d[5];else j=[],k=[],"number"!=typeof c&&(g=d.length),g>3&&"function"==typeof d[g-2]?h=e.createCallback(d[--g-1],d[g--],2):g>2&&"function"==typeof d[g-1]&&(h=d[--g]);for(;++f<g;)(td(d[f])?Ab:Cd)(d[f],function(b,c){var d,e,f=b,g=a[c];if(b&&((e=td(b))||Dd(b))){for(var l=j.length;l--;)if(d=j[l]==b){g=k[l];break}d||(g=e?td(g)?g:[]:Dd(g)?g:{},h&&(f=h(g,b),"undefined"!=typeof f&&(g=f)),j.push(b),k.push(g),h||(g=pb(g,b,i,h,j,k)))}else h&&(f=h(g,b),"undefined"==typeof f&&(f=b)),"undefined"!=typeof f&&(g=f);a[c]=g});return a}function qb(a,b,c){var d="function"==typeof b,f={};if(d)b=e.createCallback(b,c);else var g=Wc.apply(Qc,arguments);return Bd(a,function(a,c,e){(d?!b(a,c,e):Tb(g,c,1)<0)&&(f[c]=a)}),f}function rb(a){for(var b=-1,c=vd(a),d=c.length,e=Gc(d);++b<d;){var f=c[b];e[b]=[f,a[f]]}return e}function sb(a,b,c){var d={};if("function"!=typeof b)for(var f=0,g=Wc.apply(Qc,arguments),h=ib(a)?g.length:0;++f<h;){var i=g[f];i in a&&(d[i]=a[i])}else b=e.createCallback(b,c),Bd(a,function(a,c,e){b(a,c,e)&&(d[c]=a)});return d}function tb(a){for(var b=-1,c=vd(a),d=c.length,e=Gc(d);++b<d;)e[b]=a[c[b]];return e}function ub(a){var b=-1,c=Wc.apply(Qc,U(arguments,1)),d=c.length,e=Gc(d);for(od.unindexedChars&&nb(a)&&(a=a.split(""));++b<d;)e[b]=a[c[b]];return e}function vb(a,b,c){var d=-1,e=a?a.length:0,f=!1;return c=(0>c?hd(0,e+c):c)||0,"number"==typeof e?f=(nb(a)?a.indexOf(b,c):Tb(a,b,c))>-1:wd(a,function(a){return++d>=c?!(f=a===b):void 0}),f}function wb(a,b,c){var d={};return b=e.createCallback(b,c),Ab(a,function(a,c,e){c=Oc(b(a,c,e)),Zc.call(d,c)?d[c]++:d[c]=1}),d}function xb(a,b,c){var d=!0;if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g&&(d=!!b(a[f],f,a)););else wd(a,function(a,c,e){return d=!!b(a,c,e)});return d}function yb(a,b,c){var d=[];if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g;){var h=a[f];b(h,f,a)&&d.push(h)}else wd(a,function(a,c,e){b(a,c,e)&&d.push(a)});return d}function zb(a,b,c){if(b=e.createCallback(b,c),!td(a)){var d;return wd(a,function(a,c,e){return b(a,c,e)?(d=a,!1):void 0}),d}for(var f=-1,g=a.length;++f<g;){var h=a[f];if(b(h,f,a))return h}}function Ab(a,b,c){if(b&&"undefined"==typeof c&&td(a))for(var d=-1,e=a.length;++d<e&&b(a[d],d,a)!==!1;);else wd(a,b,c);return a}function Bb(a,b,c){var d={};return b=e.createCallback(b,c),Ab(a,function(a,c,e){c=Oc(b(a,c,e)),(Zc.call(d,c)?d[c]:d[c]=[]).push(a)}),d}function Cb(a,b){var c=U(arguments,2),d=-1,e="function"==typeof b,f=a?a.length:0,g=Gc("number"==typeof f?f:0);return Ab(a,function(a){g[++d]=(e?b:a[b]).apply(a,c)}),g}function Db(a,b,c){var d=-1,f=a?a.length:0,g=Gc("number"==typeof f?f:0);if(b=e.createCallback(b,c),td(a))for(;++d<f;)g[d]=b(a[d],d,a);else wd(a,function(a,c,e){g[++d]=b(a,c,e)});return g}function Eb(a,b,c){var d=-1/0,f=d;if(!b&&td(a))for(var g=-1,h=a.length;++g<h;){var i=a[g];i>f&&(f=i)}else b=!b&&nb(a)?K:e.createCallback(b,c),wd(a,function(a,c,e){var g=b(a,c,e);g>d&&(d=g,f=a)});return f}function Fb(a,b,c){var d=1/0,f=d;if(!b&&td(a))for(var g=-1,h=a.length;++g<h;){var i=a[g];f>i&&(f=i)}else b=!b&&nb(a)?K:e.createCallback(b,c),wd(a,function(a,c,e){var g=b(a,c,e);d>g&&(d=g,f=a)});return f}function Gb(a,b,c,d){var f=arguments.length<3;if(b=e.createCallback(b,d,4),td(a)){var g=-1,h=a.length;for(f&&(c=a[++g]);++g<h;)c=b(c,a[g],g,a)}else wd(a,function(a,d,e){c=f?(f=!1,a):b(c,a,d,e)});return c}function Hb(a,b,c,d){var f=a,g=a?a.length:0,h=arguments.length<3;if("number"!=typeof g){var i=vd(a);g=i.length}else od.unindexedChars&&nb(a)&&(f=a.split(""));return b=e.createCallback(b,d,4),Ab(a,function(a,d,e){d=i?i[--g]:--g,c=h?(h=!1,f[d]):b(c,f[d],d,e)}),c}function Ib(a,b,c){return b=e.createCallback(b,c),yb(a,function(a,c,d){return!b(a,c,d)})}function Jb(a){var b=-1,c=a?a.length:0,d=Gc("number"==typeof c?c:0);return Ab(a,function(a){var c=Xc(kd()*(++b+1));d[b]=d[c],d[c]=a}),d}function Kb(a){var b=a?a.length:0;return"number"==typeof b?b:vd(a).length}function Lb(a,b,c){var d;if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g&&!(d=b(a[f],f,a)););else wd(a,function(a,c,e){return!(d=b(a,c,e))});return!!d}function Mb(a,b,c){var d=-1,f=a?a.length:0,g=Gc("number"==typeof f?f:0);for(b=e.createCallback(b,c),Ab(a,function(a,c,e){g[++d]={criteria:b(a,c,e),index:d,value:a}}),f=g.length,g.sort(L);f--;)g[f]=g[f].value;return g}function Nb(a){return a&&"number"==typeof a.length?od.unindexedChars&&nb(a)?a.split(""):U(a):tb(a)}function Ob(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d}function Pb(a){for(var b=-1,c=a?a.length:0,d=Wc.apply(Qc,arguments),e=g(d,c,100),f=[];++b<c;){var h=a[b];e(h)||f.push(h)}return f}function Qb(a,b,c){var d=-1,f=a?a.length:0;for(b=e.createCallback(b,c);++d<f;)if(b(a[d],d,a))return d;return-1}function Rb(a,b,c){if(a){var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=-1;for(b=e.createCallback(b,c);++g<f&&b(a[g],g,a);)d++}else if(d=b,null==d||c)return a[0];return U(a,0,id(hd(0,d),f))}}function Sb(a,b,c,d){var f=-1,g=a?a.length:0,h=[];for("boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1),null!=c&&(c=e.createCallback(c,d));++f<g;){var i=a[f];c&&(i=c(i,f,a)),td(i)?$c.apply(h,b?i:Sb(i)):h.push(i)}return h}function Tb(a,b,c){var d=-1,e=a?a.length:0;if("number"==typeof c)d=(0>c?hd(0,e+c):c||0)-1;else if(c)return d=$b(a,b),a[d]===b?d:-1;for(;++d<e;)if(a[d]===b)return d;return-1}function Ub(a,b,c){if(!a)return[];var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=f;for(b=e.createCallback(b,c);g--&&b(a[g],g,a);)d++}else d=null==b||c?1:b||d;return U(a,0,id(hd(0,f-d),f))}function Vb(a){var b=arguments,c=b.length,d={0:{}},e=-1,f=a?a.length:0,h=f>=100,i=[],j=i;a:for(;++e<f;){var k=a[e];if(h)var l=Oc(k),m=Zc.call(d[0],l)?!(j=d[0][l]):j=d[0][l]=[];if(m||Tb(j,k)<0){h&&j.push(k);for(var n=c;--n;)if(!(d[n]||(d[n]=g(b[n],0,100)))(k))continue a;i.push(k)}}return i}function Wb(a,b,c){if(a){var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=f;for(b=e.createCallback(b,c);g--&&b(a[g],g,a);)d++}else if(d=b,null==d||c)return a[f-1];return U(a,hd(0,f-d))}}function Xb(a,b,c){var d=a?a.length:0;for("number"==typeof c&&(d=(0>c?hd(0,d+c):id(c,d-1))+1);d--;)if(a[d]===b)return d;return-1}function Yb(a,b,c){a=+a||0,c=+c||1,null==b&&(b=a,a=0);for(var d=-1,e=hd(0,Uc((b-a)/c)),f=Gc(e);++d<e;)f[d]=a,a+=c;return f}function Zb(a,b,c){if("number"!=typeof b&&null!=b){var d=0,f=-1,g=a?a.length:0;for(b=e.createCallback(b,c);++f<g&&b(a[f],f,a);)d++}else d=null==b||c?1:hd(0,b);return U(a,d)}function $b(a,b,c,d){var f=0,g=a?a.length:f;for(c=c?e.createCallback(c,d,1):uc,b=c(b);g>f;){var h=f+g>>>1;c(a[h])<b?f=h+1:g=h}return f}function _b(){return ac(Wc.apply(Qc,arguments))}function ac(a,b,c,d){var f=-1,g=a?a.length:0,h=[],i=h;"boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1);var j=!b&&g>=75;if(j)var k={};for(null!=c&&(i=[],c=e.createCallback(c,d));++f<g;){var l=a[f],m=c?c(l,f,a):l;if(j)var n=Oc(m),o=Zc.call(k,n)?!(i=k[n]):i=k[n]=[];(b?!f||i[i.length-1]!==m:o||Tb(i,m)<0)&&((c||j)&&i.push(m),h.push(l))}return h}function bc(a){for(var b=-1,c=a?a.length:0,d=g(arguments,1,30),e=[];++b<c;){var f=a[b];d(f)||e.push(f)}return e}function cc(a){for(var b=-1,c=a?Eb(Ed(arguments,"length")):0,d=Gc(c);++b<c;)d[b]=Ed(arguments,b);return d}function dc(a,b){for(var c=-1,d=a?a.length:0,e={};++c<d;){var f=a[c];b?e[f]=b[c]:e[f[0]]=f[1]}return e}function ec(a,b){return 1>a?b():function(){return--a<1?b.apply(this,arguments):void 0}}function fc(a,b){return od.fastBind||cd&&arguments.length>2?cd.call.apply(cd,arguments):M(a,b,U(arguments,2))}function gc(a){for(var b=Wc.apply(Qc,arguments),c=b.length>1?0:(b=$(a),-1),d=b.length;++c<d;){var e=b[c];a[e]=fc(a[e],a)}return a}function hc(a,b){return M(a,b,U(arguments,2),i)}function ic(){var a=arguments;return function(){for(var b=arguments,c=a.length;c--;)b=[a[c].apply(this,b)];return b[0]}}function jc(a,b,c){if(null==a)return uc;var d=typeof a;if("function"!=d){if("object"!=d)return function(b){return b[a]};var e=vd(a);return function(b){for(var c=e.length,d=!1;c--&&(d=fb(b[e[c]],a[e[c]],i)););return d}}return"undefined"!=typeof b?1===c?function(c){return a.call(b,c)}:2===c?function(c,d){return a.call(b,c,d)}:4===c?function(c,d,e,f){return a.call(b,c,d,e,f)}:function(c,d,e){return a.call(b,c,d,e)}:a}function kc(a,b,c){function d(){h=null,c||(f=a.apply(g,e))}var e,f,g,h;return function(){var i=c&&!h;return e=arguments,g=this,Vc(h),h=ad(d,b),i&&(f=a.apply(g,e)),f}}function lc(a){var b=U(arguments,1);return ad(function(){a.apply(c,b)},1)}function mc(a,b){var d=U(arguments,2);return ad(function(){a.apply(c,d)},b)}function nc(a,b){var c={};return function(){var d=Oc(b?b.apply(this,arguments):arguments[0]);return Zc.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}}function oc(a){var b,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}}function pc(a){return M(a,U(arguments,1))}function qc(a){return M(a,U(arguments,1),null,i)}function rc(a,b){function c(){h=new Ic,g=null,e=a.apply(f,d)}var d,e,f,g,h=0;return function(){var i=new Ic,j=b-(i-h);return d=arguments,f=this,0>=j?(Vc(g),g=null,h=i,e=a.apply(f,d)):g||(g=ad(c,j)),e}}function sc(a,b){return function(){var c=[a];return $c.apply(c,arguments),b.apply(this,c)}}function tc(a){return null==a?"":Oc(a).replace(s,P)}function uc(a){return a}function vc(a){Ab($(a),function(b){var c=e[b]=a[b];e.prototype[b]=function(){var a=this.__wrapped__,b=[a];$c.apply(b,arguments);var d=c.apply(e,b);return a&&"object"==typeof a&&a==d?this:new R(d)}})}function wc(){return d._=Sc,this}function xc(a,b){return null==a&&null==b&&(b=1),a=+a||0,null==b&&(b=a,a=0),a+Xc(kd()*((+b||0)-a+1))}function yc(a,b){var d=a?a[b]:c;return hb(d)?a[b]():d}function zc(a,b,d){var f=e.templateSettings;a||(a=""),d=Ad({},d,f);var g,h=Ad({},d.imports,f.imports),i=vd(h),m=tb(h),o=0,q=d.interpolate||r,s="__p += '",u=Nc((d.escape||r).source+"|"+q.source+"|"+(q===p?n:r).source+"|"+(d.evaluate||r).source+"|$","g");a.replace(u,function(b,c,d,e,f,h){return d||(d=e),s+=a.slice(o,h).replace(t,O),c&&(s+="' +\n__e("+c+") +\n'"),f&&(g=!0,s+="';\n"+f+";\n__p += '"),d&&(s+="' +\n((__t = ("+d+")) == null ? '' : __t) +\n'"),o=h+b.length,b}),s+="';\n";var v=d.variable,x=v;x||(v="obj",s="with ("+v+") {\n"+s+"\n}\n"),s=(g?s.replace(j,""):s).replace(k,"$1").replace(l,"$1;"),s="function("+v+") {\n"+(x?"":v+" || ("+v+" = {});\n")+"var __t, __p = '', __e = _.escape"+(g?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+s+"return __p\n}";var y="\n/*\n//@ sourceURL="+(d.sourceURL||"/lodash/template/source["+w++ +"]")+"\n*/";try{var z=Jc(i,"return "+s+y).apply(c,m)}catch(A){throw A.source=s,A}return b?z(b):(z.source=s,z)}function Ac(a,b,c){a=(a=+a)>-1?a:0;var d=-1,f=Gc(a);for(b=e.createCallback(b,c,1);++d<a;)f[d]=b(d);return f}function Bc(a){return null==a?"":Oc(a).replace(m,V)}function Cc(a){var b=++h;return Oc(null==a?"":a)+b}function Dc(a,b){return b(a),a}function Ec(){return Oc(this.__wrapped__)}function Fc(){return this.__wrapped__}d=d?J.defaults(a.Object(),d,J.pick(a,u)):a;var Gc=d.Array,Hc=d.Boolean,Ic=d.Date,Jc=d.Function,Kc=d.Math,Lc=d.Number,Mc=d.Object,Nc=d.RegExp,Oc=d.String,Pc=d.TypeError,Qc=Gc(),Rc=Mc(),Sc=d._,Tc=Nc("^"+Oc(Rc.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),Uc=Kc.ceil,Vc=d.clearTimeout,Wc=Qc.concat,Xc=Kc.floor,Yc=Tc.test(Yc=Mc.getPrototypeOf)&&Yc,Zc=Rc.hasOwnProperty,$c=Qc.push,_c=d.setImmediate,ad=d.setTimeout,bd=Rc.toString,cd=Tc.test(cd=U.bind)&&cd,dd=Tc.test(dd=Gc.isArray)&&dd,ed=d.isFinite,fd=d.isNaN,gd=Tc.test(gd=Mc.keys)&&gd,hd=Kc.max,id=Kc.min,jd=d.parseInt,kd=Kc.random,ld=Tc.test(d.attachEvent),md=cd&&!/\n|true/.test(cd+ld),nd={};nd[y]=Gc,nd[z]=Hc,nd[A]=Ic,nd[D]=Mc,nd[C]=Lc,nd[E]=Nc,nd[F]=Oc;var od=e.support={};!function(){var a=function(){this.x=1},b={0:1,length:1},c=[];a.prototype={valueOf:1,y:1};for(var d in new a)c.push(d);for(d in arguments);od.argsObject=arguments.constructor==Mc,od.argsClass=W(arguments),od.enumPrototypes=a.propertyIsEnumerable("prototype"),od.fastBind=cd&&!md,od.ownLast="x"!=c[0],od.nonEnumArgs=0!=d,od.nonEnumShadows=!/valueOf/.test(c),od.spliceObjects=(Qc.splice.call(b,0,1),!b[0]),od.unindexedChars="xx"!="x"[0]+Mc("x")[0];try{od.nodeClass=!(bd.call(document)==D&&!({toString:0}+""))}catch(e){od.nodeClass=!0}}(1),e.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:p,variable:"",imports:{_:e}};var pd=function(a){var b="var index, iterable = "+a.firstArg+", result = "+a.init+";\nif (!iterable) return result;\n"+a.top+";\n";if(a.arrays?(b+="var length = iterable.length; index = -1;\nif ("+a.arrays+") {  ",od.unindexedChars&&(b+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),b+="\n  while (++index < length) {\n    "+a.loop+"\n  }\n}\nelse {  "):od.nonEnumArgs&&(b+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+a.loop+"\n    }\n  } else {  "),od.enumPrototypes&&(b+="\n  var skipProto = typeof iterable == 'function';\n  "),a.useHas&&a.useKeys)b+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",od.enumPrototypes&&(b+="if (!(skipProto && index == 'prototype')) {\n  "),b+=a.loop,od.enumPrototypes&&(b+="}\n"),b+="  }  ";else if(b+="\n  for (index in iterable) {",(od.enumPrototypes||a.useHas)&&(b+="\n    if (",od.enumPrototypes&&(b+="!(skipProto && index == 'prototype')"),od.enumPrototypes&&a.useHas&&(b+=" && "),a.useHas&&(b+="hasOwnProperty.call(iterable, index)"),b+=") {    "),b+=a.loop+";    ",(od.enumPrototypes||a.useHas)&&(b+="\n    }"),b+="\n  }    ",od.nonEnumShadows){b+="\n\n  var ctor = iterable.constructor;\n      ";for(var c=0;7>c;c++)b+="\n  index = '"+a.shadowedProps[c]+"';\n  if (","constructor"==a.shadowedProps[c]&&(b+="!(ctor && ctor.prototype === iterable) && "),b+="hasOwnProperty.call(iterable, index)) {\n    "+a.loop+"\n  }      "}return(a.arrays||od.nonEnumArgs)&&(b+="\n}"),b+=a.bottom+";\nreturn result"},qd={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},rd={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},sd={top:"if (!objectTypes[typeof iterable]) return result;\n"+rd.top,arrays:!1};R.prototype=e.prototype,od.argsClass||(W=function(a){return a?Zc.call(a,"callee"):!1});var td=dd||function(a){return od.argsObject&&a instanceof Gc||bd.call(a)==y},ud=N({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),vd=gd?function(a){return ib(a)?od.enumPrototypes&&"function"==typeof a||od.nonEnumArgs&&a.length&&W(a)?ud(a):gd(a):[]}:ud,wd=N(rd),xd={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},yd=ab(xd),zd=N(qd,{top:qd.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),Ad=N(qd),Bd=N(rd,sd,{useHas:!1}),Cd=N(rd,sd);hb(/x/)&&(hb=function(a){return a instanceof Jc||bd.call(a)==B});var Dd=Yc?function(a){if(!a||bd.call(a)!=D||!od.argsClass&&W(a))return!1;var b=a.valueOf,c="function"==typeof b&&(c=Yc(b))&&Yc(c);return c?a==c||Yc(a)==c:T(a)}:T,Ed=Db,Fd=yb;md&&f&&"function"==typeof _c&&(lc=fc(_c,d));var Gd=8==jd("08")?jd:function(a,b){return jd(nb(a)?a.replace(q,""):a,b||0)};return e.after=ec,e.assign=zd,e.at=ub,e.bind=fc,e.bindAll=gc,e.bindKey=hc,e.compact=Ob,e.compose=ic,e.countBy=wb,e.createCallback=jc,e.debounce=kc,e.defaults=Ad,e.defer=lc,e.delay=mc,e.difference=Pb,e.filter=yb,e.flatten=Sb,e.forEach=Ab,e.forIn=Bd,e.forOwn=Cd,e.functions=$,e.groupBy=Bb,e.initial=Ub,e.intersection=Vb,e.invert=ab,e.invoke=Cb,e.keys=vd,e.map=Db,e.max=Eb,e.memoize=nc,e.merge=pb,e.min=Fb,e.omit=qb,e.once=oc,e.pairs=rb,e.partial=pc,e.partialRight=qc,e.pick=sb,e.pluck=Ed,e.range=Yb,e.reject=Ib,e.rest=Zb,e.shuffle=Jb,e.sortBy=Mb,e.tap=Dc,e.throttle=rc,e.times=Ac,e.toArray=Nb,e.union=_b,e.uniq=ac,e.values=tb,e.where=Fd,e.without=bc,e.wrap=sc,e.zip=cc,e.zipObject=dc,e.collect=Db,e.drop=Zb,e.each=Ab,e.extend=zd,e.methods=$,e.object=dc,e.select=yb,e.tail=Zb,e.unique=ac,vc(e),e.clone=X,e.cloneDeep=Y,e.contains=vb,e.escape=tc,e.every=xb,e.find=zb,e.findIndex=Qb,e.findKey=Z,e.has=_,e.identity=uc,e.indexOf=Tb,e.isArguments=W,e.isArray=td,e.isBoolean=bb,e.isDate=cb,e.isElement=db,e.isEmpty=eb,e.isEqual=fb,e.isFinite=gb,e.isFunction=hb,e.isNaN=jb,e.isNull=kb,e.isNumber=lb,e.isObject=ib,e.isPlainObject=Dd,e.isRegExp=mb,e.isString=nb,e.isUndefined=ob,e.lastIndexOf=Xb,e.mixin=vc,e.noConflict=wc,e.parseInt=Gd,e.random=xc,e.reduce=Gb,e.reduceRight=Hb,e.result=yc,e.runInContext=b,e.size=Kb,e.some=Lb,e.sortedIndex=$b,e.template=zc,e.unescape=Bc,e.uniqueId=Cc,e.all=xb,e.any=Lb,e.detect=zb,e.foldl=Gb,e.foldr=Hb,e.include=vb,e.inject=Gb,Cd(e,function(a,b){e.prototype[b]||(e.prototype[b]=function(){var b=[this.__wrapped__];return $c.apply(b,arguments),a.apply(e,b)})}),e.first=Rb,e.last=Wb,e.take=Rb,e.head=Rb,Cd(e,function(a,b){e.prototype[b]||(e.prototype[b]=function(b,c){var d=a(this.__wrapped__,b,c);return null==b||c&&"function"!=typeof b?d:new R(d)})}),e.VERSION="1.1.1",e.prototype.toString=Ec,e.prototype.value=Fc,e.prototype.valueOf=Fc,wd(["join","pop","shift"],function(a){var b=Qc[a];e.prototype[a]=function(){return b.apply(this.__wrapped__,arguments)}}),wd(["push","reverse","sort","unshift"],function(a){var b=Qc[a];e.prototype[a]=function(){return b.apply(this.__wrapped__,arguments),this}}),wd(["concat","slice","splice"],function(a){var b=Qc[a];e.prototype[a]=function(){return new R(b.apply(this.__wrapped__,arguments))}}),od.spliceObjects||wd(["pop","shift","splice"],function(a){var b=Qc[a],c="splice"==a;e.prototype[a]=function(){var a=this.__wrapped__,d=b.apply(a,arguments);return 0===a.length&&delete a[0],c?new R(d):d}}),e}var c,e="object"==typeof exports&&exports,f="object"==typeof module&&module&&module.exports==e&&module,g="object"==typeof global&&global;g.global===g&&(a=g);var h=0,i={},j=/\b__p \+= '';/g,k=/\b(__p \+=) '' \+/g,l=/(__e\(.*?\)|\b__t\)) \+\n'';/g,m=/&(?:amp|lt|gt|quot|#39);/g,n=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,o=/\w*$/,p=/<%=([\s\S]+?)%>/g,q=/^0+(?=.$)/,r=/($^)/,s=/[&<>"']/g,t=/['\n\r\t\u2028\u2029\\]/g,u=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setImmediate","setTimeout"],v=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],w=0,x="[object Arguments]",y="[object Array]",z="[object Boolean]",A="[object Date]",B="[object Function]",C="[object Number]",D="[object Object]",E="[object RegExp]",F="[object String]",G={};
G[B]=!1,G[x]=G[y]=G[z]=G[A]=G[C]=G[D]=G[E]=G[F]=!0;var H={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},I={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},J=b();"function"==typeof d&&"object"==typeof d.amd&&d.amd?(a._=J,d("_",[],function(){return J})):e&&!e.nodeType?f?(f.exports=J)._=J:e._=J:a._=J}(this),d("core/base",["require","./mixin/derive","./mixin/notifier","./cache","_"],function(a){var b=a("./mixin/derive"),c=a("./mixin/notifier"),d=a("./cache"),e=a("_"),f=function(){this.cache=new d};return e.extend(f,b),e.extend(f.prototype,c),f}),function(a){var b={};"undefined"==typeof exports?"function"==typeof d&&"object"==typeof d.amd&&d.amd?(b.exports={},d("glmatrix",[],function(){return b.exports})):b.exports="undefined"!=typeof window?window:a:b.exports=exports,function(a){if(!b)var b=1e-6;if(!c)var c="undefined"!=typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={};e.setMatrixArrayType=function(a){c=a},"undefined"!=typeof a&&(a.glMatrix=e);var f={};f.create=function(){var a=new c(2);return a[0]=0,a[1]=0,a},f.clone=function(a){var b=new c(2);return b[0]=a[0],b[1]=a[1],b},f.fromValues=function(a,b){var d=new c(2);return d[0]=a,d[1]=b,d},f.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},f.set=function(a,b,c){return a[0]=b,a[1]=c,a},f.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a},f.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},f.sub=f.subtract,f.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a},f.mul=f.multiply,f.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a},f.div=f.divide,f.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a},f.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a},f.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},f.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a},f.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},f.dist=f.distance,f.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},f.sqrDist=f.squaredDistance,f.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},f.len=f.length,f.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},f.sqrLen=f.squaredLength,f.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a},f.normalize=function(a,b){var c=b[0],d=b[1],e=c*c+d*d;return e>0&&(e=1/Math.sqrt(e),a[0]=b[0]*e,a[1]=b[1]*e),a},f.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},f.cross=function(a,b,c){var d=b[0]*c[1]-b[1]*c[0];return a[0]=a[1]=0,a[2]=d,a},f.lerp=function(a,b,c,d){var e=b[0],f=b[1];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a},f.random=function(a,b){b=b||1;var c=2*d()*Math.PI;return a[0]=Math.cos(c)*b,a[1]=Math.sin(c)*b,a},f.transformMat2=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e,a[1]=c[1]*d+c[3]*e,a},f.transformMat2d=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e+c[4],a[1]=c[1]*d+c[3]*e+c[5],a},f.transformMat3=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[3]*e+c[6],a[1]=c[1]*d+c[4]*e+c[7],a},f.transformMat4=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[4]*e+c[12],a[1]=c[1]*d+c[5]*e+c[13],a},f.forEach=function(){var a=f.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=2),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],f(a,a,g),b[h]=a[0],b[h+1]=a[1];return b}}(),f.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},"undefined"!=typeof a&&(a.vec2=f);var g={};g.create=function(){var a=new c(3);return a[0]=0,a[1]=0,a[2]=0,a},g.clone=function(a){var b=new c(3);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},g.fromValues=function(a,b,d){var e=new c(3);return e[0]=a,e[1]=b,e[2]=d,e},g.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},g.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},g.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},g.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},g.sub=g.subtract,g.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a},g.mul=g.multiply,g.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a},g.div=g.divide,g.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a},g.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a},g.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},g.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a},g.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)},g.dist=g.distance,g.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return c*c+d*d+e*e},g.sqrDist=g.squaredDistance,g.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},g.len=g.length,g.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},g.sqrLen=g.squaredLength,g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a},g.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*c+d*d+e*e;return f>0&&(f=1/Math.sqrt(f),a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f),a},g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},g.cross=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return a[0]=e*i-f*h,a[1]=f*g-d*i,a[2]=d*h-e*g,a},g.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a},g.random=function(a,b){b=b||1;var c=2*d()*Math.PI,e=2*d()-1,f=Math.sqrt(1-e*e)*b;return a[0]=Math.cos(c)*f,a[1]=Math.sin(c)*f,a[2]=e*b,a},g.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a[2]=c[2]*d+c[6]*e+c[10]*f+c[14],a},g.transformMat3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=d*c[0]+e*c[3]+f*c[6],a[1]=d*c[1]+e*c[4]+f*c[7],a[2]=d*c[2]+e*c[5]+f*c[8],a},g.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},g.forEach=function(){var a=g.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=3),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2];return b}}(),g.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},"undefined"!=typeof a&&(a.vec3=g);var h={};h.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},h.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},h.fromValues=function(a,b,d,e){var f=new c(4);return f[0]=a,f[1]=b,f[2]=d,f[3]=e,f},h.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},h.set=function(a,b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,a[3]=e,a},h.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a[3]=b[3]+c[3],a},h.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a[3]=b[3]-c[3],a},h.sub=h.subtract,h.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a[3]=b[3]*c[3],a},h.mul=h.multiply,h.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a[3]=b[3]/c[3],a},h.div=h.divide,h.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a[3]=Math.min(b[3],c[3]),a},h.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a[3]=Math.max(b[3],c[3]),a},h.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a[3]=b[3]*c,a},h.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a[3]=b[3]+c[3]*d,a},h.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return Math.sqrt(c*c+d*d+e*e+f*f)},h.dist=h.distance,h.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return c*c+d*d+e*e+f*f},h.sqrDist=h.squaredDistance,h.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},h.len=h.length,h.squaredLength=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return b*b+c*c+d*d+e*e},h.sqrLen=h.squaredLength,h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a},h.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f;return g>0&&(g=1/Math.sqrt(g),a[0]=b[0]*g,a[1]=b[1]*g,a[2]=b[2]*g,a[3]=b[3]*g),a},h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},h.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[3];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a[3]=h+d*(c[3]-h),a},h.random=function(a,b){return b=b||1,a[0]=d(),a[1]=d(),a[2]=d(),a[3]=d(),h.normalize(a,a),h.scale(a,a,b),a},h.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*g,a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*g,a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*g,a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*g,a},h.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},h.forEach=function(){var a=h.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=4),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],a[3]=b[h+3],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2],b[h+3]=a[3];return b}}(),h.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.vec4=h);var i={};i.create=function(){var a=new c(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},i.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},i.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.transpose=function(a,b){if(a===b){var c=b[1];a[1]=b[2],a[2]=c}else a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},i.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*f-e*d;return g?(g=1/g,a[0]=f*g,a[1]=-d*g,a[2]=-e*g,a[3]=c*g,a):null},i.adjoint=function(a,b){var c=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=c,a},i.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},i.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*h+e*j,a[1]=d*i+e*k,a[2]=f*h+g*j,a[3]=f*i+g*k,a},i.mul=i.multiply,i.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=d*-h+e*i,a[2]=f*i+g*h,a[3]=f*-h+g*i,a},i.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1];return a[0]=d*h,a[1]=e*i,a[2]=f*h,a[3]=g*i,a},i.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.mat2=i);var j={};j.create=function(){var a=new c(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.clone=function(a){var b=new c(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},j.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},j.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=c*f-d*e;return i?(i=1/i,a[0]=f*i,a[1]=-d*i,a[2]=-e*i,a[3]=c*i,a[4]=(e*h-f*g)*i,a[5]=(d*g-c*h)*i,a):null},j.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},j.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1],l=c[2],m=c[3],n=c[4],o=c[5];return a[0]=d*j+e*l,a[1]=d*k+e*m,a[2]=f*j+g*l,a[3]=f*k+g*m,a[4]=j*h+l*i+n,a[5]=k*h+m*i+o,a},j.mul=j.multiply,j.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=Math.sin(c),k=Math.cos(c);return a[0]=d*k+e*j,a[1]=-d*j+e*k,a[2]=f*k+g*j,a[3]=-f*j+k*g,a[4]=k*h+j*i,a[5]=k*i-j*h,a},j.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=b[0]*d,a[1]=b[1]*e,a[2]=b[2]*d,a[3]=b[3]*e,a[4]=b[4]*d,a[5]=b[5]*e,a},j.translate=function(a,b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4]+c[0],a[5]=b[5]+c[1],a},j.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},"undefined"!=typeof a&&(a.mat2d=j);var k={};k.create=function(){var a=new c(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.fromMat4=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},k.clone=function(a){var b=new c(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},k.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},k.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(o=1/o,a[0]=l*o,a[1]=(-k*d+e*j)*o,a[2]=(h*d-e*g)*o,a[3]=m*o,a[4]=(k*c-e*i)*o,a[5]=(-h*c+e*f)*o,a[6]=n*o,a[7]=(-j*c+d*i)*o,a[8]=(g*c-d*f)*o,a):null},k.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return a[0]=g*k-h*j,a[1]=e*j-d*k,a[2]=d*h-e*g,a[3]=h*i-f*k,a[4]=c*k-e*i,a[5]=e*f-c*h,a[6]=f*j-g*i,a[7]=d*i-c*j,a[8]=c*g-d*f,a},k.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*(j*f-g*i)+c*(-j*e+g*h)+d*(i*e-f*h)},k.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=m*d+n*g+o*j,a[1]=m*e+n*h+o*k,a[2]=m*f+n*i+o*l,a[3]=p*d+q*g+r*j,a[4]=p*e+q*h+r*k,a[5]=p*f+q*i+r*l,a[6]=s*d+t*g+u*j,a[7]=s*e+t*h+u*k,a[8]=s*f+t*i+u*l,a},k.mul=k.multiply,k.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=m*d+n*g+j,a[7]=m*e+n*h+k,a[8]=m*f+n*i+l,a},k.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=Math.sin(c),n=Math.cos(c);return a[0]=n*d+m*g,a[1]=n*e+m*h,a[2]=n*f+m*i,a[3]=n*g-m*d,a[4]=n*h-m*e,a[5]=n*i-m*f,a[6]=j,a[7]=k,a[8]=l,a},k.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=e*b[3],a[4]=e*b[4],a[5]=e*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a},k.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[3]=k+r,a[6]=l-q,a[1]=k-r,a[4]=1-(j+o),a[7]=n+p,a[2]=l+q,a[5]=n-p,a[8]=1-(j+m),a},k.normalFromMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(i*A-g*D-j*z)*E,a[2]=(g*C-h*A+j*y)*E,a[3]=(e*C-d*D-f*B)*E,a[4]=(c*D-e*A+f*z)*E,a[5]=(d*A-c*C-f*y)*E,a[6]=(p*x-q*w+r*v)*E,a[7]=(q*u-o*x-r*t)*E,a[8]=(o*w-p*u+r*s)*E,a):null},k.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},"undefined"!=typeof a&&(a.mat3=k);var l={};l.create=function(){var a=new c(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.clone=function(a){var b=new c(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},l.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=f,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},l.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(e*C-d*D-f*B)*E,a[2]=(p*x-q*w+r*v)*E,a[3]=(m*w-l*x-n*v)*E,a[4]=(i*A-g*D-j*z)*E,a[5]=(c*D-e*A+f*z)*E,a[6]=(q*u-o*x-r*t)*E,a[7]=(k*x-m*u+n*t)*E,a[8]=(g*C-h*A+j*y)*E,a[9]=(d*A-c*C-f*y)*E,a[10]=(o*w-p*u+r*s)*E,a[11]=(l*u-k*w-n*s)*E,a[12]=(h*z-g*B-i*y)*E,a[13]=(c*B-d*z+e*y)*E,a[14]=(p*t-o*v-q*s)*E,a[15]=(k*v-l*t+m*s)*E,a):null},l.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15];return a[0]=h*(m*r-n*q)-l*(i*r-j*q)+p*(i*n-j*m),a[1]=-(d*(m*r-n*q)-l*(e*r-f*q)+p*(e*n-f*m)),a[2]=d*(i*r-j*q)-h*(e*r-f*q)+p*(e*j-f*i),a[3]=-(d*(i*n-j*m)-h*(e*n-f*m)+l*(e*j-f*i)),a[4]=-(g*(m*r-n*q)-k*(i*r-j*q)+o*(i*n-j*m)),a[5]=c*(m*r-n*q)-k*(e*r-f*q)+o*(e*n-f*m),a[6]=-(c*(i*r-j*q)-g*(e*r-f*q)+o*(e*j-f*i)),a[7]=c*(i*n-j*m)-g*(e*n-f*m)+k*(e*j-f*i),a[8]=g*(l*r-n*p)-k*(h*r-j*p)+o*(h*n-j*l),a[9]=-(c*(l*r-n*p)-k*(d*r-f*p)+o*(d*n-f*l)),a[10]=c*(h*r-j*p)-g*(d*r-f*p)+o*(d*j-f*h),a[11]=-(c*(h*n-j*l)-g*(d*n-f*l)+k*(d*j-f*h)),a[12]=-(g*(l*q-m*p)-k*(h*q-i*p)+o*(h*m-i*l)),a[13]=c*(l*q-m*p)-k*(d*q-e*p)+o*(d*m-e*l),a[14]=-(c*(h*q-i*p)-g*(d*q-e*p)+o*(d*i-e*h)),a[15]=c*(h*m-i*l)-g*(d*m-e*l)+k*(d*i-e*h),a},l.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p;return r*C-s*B+t*A+u*z-v*y+w*x},l.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3];return a[0]=t*d+u*h+v*l+w*p,a[1]=t*e+u*i+v*m+w*q,a[2]=t*f+u*j+v*n+w*r,a[3]=t*g+u*k+v*o+w*s,t=c[4],u=c[5],v=c[6],w=c[7],a[4]=t*d+u*h+v*l+w*p,a[5]=t*e+u*i+v*m+w*q,a[6]=t*f+u*j+v*n+w*r,a[7]=t*g+u*k+v*o+w*s,t=c[8],u=c[9],v=c[10],w=c[11],a[8]=t*d+u*h+v*l+w*p,a[9]=t*e+u*i+v*m+w*q,a[10]=t*f+u*j+v*n+w*r,a[11]=t*g+u*k+v*o+w*s,t=c[12],u=c[13],v=c[14],w=c[15],a[12]=t*d+u*h+v*l+w*p,a[13]=t*e+u*i+v*m+w*q,a[14]=t*f+u*j+v*n+w*r,a[15]=t*g+u*k+v*o+w*s,a},l.mul=l.multiply,l.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=c[0],q=c[1],r=c[2];return b===a?(a[12]=b[0]*p+b[4]*q+b[8]*r+b[12],a[13]=b[1]*p+b[5]*q+b[9]*r+b[13],a[14]=b[2]*p+b[6]*q+b[10]*r+b[14],a[15]=b[3]*p+b[7]*q+b[11]*r+b[15]):(d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=j,a[7]=k,a[8]=l,a[9]=m,a[10]=n,a[11]=o,a[12]=d*p+h*q+l*r+b[12],a[13]=e*p+i*q+m*r+b[13],a[14]=f*p+j*q+n*r+b[14],a[15]=g*p+k*q+o*r+b[15]),a},l.scale=function(a,b,c){var d=c[0],e=c[1],f=c[2];return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a[4]=b[4]*e,a[5]=b[5]*e,a[6]=b[6]*e,a[7]=b[7]*e,a[8]=b[8]*f,a[9]=b[9]*f,a[10]=b[10]*f,a[11]=b[11]*f,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.rotate=function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=e[0],E=e[1],F=e[2],G=Math.sqrt(D*D+E*E+F*F);return Math.abs(G)<b?null:(G=1/G,D*=G,E*=G,F*=G,f=Math.sin(d),g=Math.cos(d),h=1-g,i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7],q=c[8],r=c[9],s=c[10],t=c[11],u=D*D*h+g,v=E*D*h+F*f,w=F*D*h-E*f,x=D*E*h-F*f,y=E*E*h+g,z=F*E*h+D*f,A=D*F*h+E*f,B=E*F*h-D*f,C=F*F*h+g,a[0]=i*u+m*v+q*w,a[1]=j*u+n*v+r*w,a[2]=k*u+o*v+s*w,a[3]=l*u+p*v+t*w,a[4]=i*x+m*y+q*z,a[5]=j*x+n*y+r*z,a[6]=k*x+o*y+s*z,a[7]=l*x+p*y+t*z,a[8]=i*A+m*B+q*C,a[9]=j*A+n*B+r*C,a[10]=k*A+o*B+s*C,a[11]=l*A+p*B+t*C,c!==a&&(a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]),a)},l.rotateX=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=f*e+j*d,a[5]=g*e+k*d,a[6]=h*e+l*d,a[7]=i*e+m*d,a[8]=j*e-f*d,a[9]=k*e-g*d,a[10]=l*e-h*d,a[11]=m*e-i*d,a},l.rotateY=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e-j*d,a[1]=g*e-k*d,a[2]=h*e-l*d,a[3]=i*e-m*d,a[8]=f*d+j*e,a[9]=g*d+k*e,a[10]=h*d+l*e,a[11]=i*d+m*e,a},l.rotateZ=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],m=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e+j*d,a[1]=g*e+k*d,a[2]=h*e+l*d,a[3]=i*e+m*d,a[4]=j*e-f*d,a[5]=k*e-g*d,a[6]=l*e-h*d,a[7]=m*e-i*d,a},l.fromRotationTranslation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return a[0]=1-(n+p),a[1]=l+s,a[2]=m-r,a[3]=0,a[4]=l-s,a[5]=1-(k+p),a[6]=o+q,a[7]=0,a[8]=m+r,a[9]=o-q,a[10]=1-(k+n),a[11]=0,a[12]=c[0],a[13]=c[1],a[14]=c[2],a[15]=1,a},l.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[1]=k+r,a[2]=l-q,a[3]=0,a[4]=k-r,a[5]=1-(j+o),a[6]=n+p,a[7]=0,a[8]=l+q,a[9]=n-p,a[10]=1-(j+m),a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.frustum=function(a,b,c,d,e,f,g){var h=1/(c-b),i=1/(e-d),j=1/(f-g);return a[0]=2*f*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f*i,a[6]=0,a[7]=0,a[8]=(c+b)*h,a[9]=(e+d)*i,a[10]=(g+f)*j,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*g*f*j,a[15]=0,a},l.perspective=function(a,b,c,d,e){var f=1/Math.tan(b/2),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(e+d)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*e*d*g,a[15]=0,a},l.ortho=function(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a},l.lookAt=function(a,c,d,e){var f,g,h,i,j,k,m,n,o,p,q=c[0],r=c[1],s=c[2],t=e[0],u=e[1],v=e[2],w=d[0],x=d[1],y=d[2];return Math.abs(q-w)<b&&Math.abs(r-x)<b&&Math.abs(s-y)<b?l.identity(a):(m=q-w,n=r-x,o=s-y,p=1/Math.sqrt(m*m+n*n+o*o),m*=p,n*=p,o*=p,f=u*o-v*n,g=v*m-t*o,h=t*n-u*m,p=Math.sqrt(f*f+g*g+h*h),p?(p=1/p,f*=p,g*=p,h*=p):(f=0,g=0,h=0),i=n*h-o*g,j=o*f-m*h,k=m*g-n*f,p=Math.sqrt(i*i+j*j+k*k),p?(p=1/p,i*=p,j*=p,k*=p):(i=0,j=0,k=0),a[0]=f,a[1]=i,a[2]=m,a[3]=0,a[4]=g,a[5]=j,a[6]=n,a[7]=0,a[8]=h,a[9]=k,a[10]=o,a[11]=0,a[12]=-(f*q+g*r+h*s),a[13]=-(i*q+j*r+k*s),a[14]=-(m*q+n*r+o*s),a[15]=1,a)},l.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},"undefined"!=typeof a&&(a.mat4=l);var m={};m.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.rotationTo=function(){var a=g.create(),b=g.fromValues(1,0,0),c=g.fromValues(0,1,0);return function(d,e,f){var h=g.dot(e,f);return-.999999>h?(g.cross(a,b,e),g.length(a)<1e-6&&g.cross(a,c,e),g.normalize(a,a),m.setAxisAngle(d,a,Math.PI),d):h>.999999?(d[0]=0,d[1]=0,d[2]=0,d[3]=1,d):(g.cross(a,e,f),d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=1+h,m.normalize(d,d))}}(),m.setAxes=function(){var a=k.create();return function(b,c,d,e){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=c[0],a[5]=c[1],a[8]=c[2],m.normalize(b,m.fromMat3(b,a))}}(),m.clone=h.clone,m.fromValues=h.fromValues,m.copy=h.copy,m.set=h.set,m.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.setAxisAngle=function(a,b,c){c=.5*c;var d=Math.sin(c);return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=Math.cos(c),a},m.add=h.add,m.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},m.mul=m.multiply,m.scale=h.scale,m.rotateX=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+g*h,a[1]=e*i+f*h,a[2]=f*i-e*h,a[3]=g*i-d*h,a},m.rotateY=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i-f*h,a[1]=e*i+g*h,a[2]=f*i+d*h,a[3]=g*i-e*h,a},m.rotateZ=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=e*i-d*h,a[2]=f*i+g*h,a[3]=g*i-f*h,a},m.calculateW=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c,a[1]=d,a[2]=e,a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a},m.dot=h.dot,m.lerp=h.lerp,m.slerp=function(a,b,c,d){var e,f,g,h,i,j=b[0],k=b[1],l=b[2],m=b[3],n=c[0],o=c[1],p=c[2],q=c[3];return f=j*n+k*o+l*p+m*q,0>f&&(f=-f,n=-n,o=-o,p=-p,q=-q),1-f>1e-6?(e=Math.acos(f),g=Math.sin(e),h=Math.sin((1-d)*e)/g,i=Math.sin(d*e)/g):(h=1-d,i=d),a[0]=h*j+i*n,a[1]=h*k+i*o,a[2]=h*l+i*p,a[3]=h*m+i*q,a},m.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return a[0]=-c*h,a[1]=-d*h,a[2]=-e*h,a[3]=f*h,a},m.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a},m.length=h.length,m.len=m.length,m.squaredLength=h.squaredLength,m.sqrLen=m.squaredLength,m.normalize=h.normalize,m.fromMat3=function(){var a="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(b,c){var d,e=c[0]+c[4]+c[8];if(e>0)d=Math.sqrt(e+1),b[3]=.5*d,d=.5/d,b[0]=(c[7]-c[5])*d,b[1]=(c[2]-c[6])*d,b[2]=(c[3]-c[1])*d;else{var f=0;c[4]>c[0]&&(f=1),c[8]>c[3*f+f]&&(f=2);var g=a[f],h=a[g];d=Math.sqrt(c[3*f+f]-c[3*g+g]-c[3*h+h]+1),b[f]=.5*d,d=.5/d,b[3]=(c[3*h+g]-c[3*g+h])*d,b[g]=(c[3*g+f]+c[3*f+g])*d,b[h]=(c[3*h+f]+c[3*f+h])*d}return b}}(),m.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.quat=m)}(b.exports)}(this),d("core/vector2",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec2,d=function(a,b){return a=a||0,b=b||0,Object.create(e,{x:{configurable:!1,set:function(a){this._array[0]=a,this._dirty=!0},get:function(){return this._array[0]}},y:{configurable:!1,set:function(a){this._array[1]=a,this._dirty=!0},get:function(){return this._array[1]}},_array:{writable:!1,configurable:!1,value:c.fromValues(a,b)},_dirty:{configurable:!1,value:!0}})},e={constructor:d,add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b){return this._array[0]=a,this._array[1]=b,this._dirty=!0,this},clone:function(){return new d(this.x,this.y)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return c.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return c.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat2:function(a){return c.transformMat2(this._array,this._array,a._array),this._dirty=!0,this},transformMat2d:function(a){return c.transformMat2d(this._array,this._array,a._array),this._dirty=!0,this},transformMat3:function(a){return c.transformMat3(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return d}),d("2d/gradient",["require","core/base","core/vector2"],function(a){var b=a("core/base");a("core/vector2");var c=b.derive(function(){return{stops:[]}},{addColorStop:function(a,b){this.stops.push([a,b]),this.dirty()},removeAt:function(a){this.stops.splice(a,1),this.dirty()},dirty:function(){for(var a in this.cache._caches)this.cache._caches[a].dirty=!0},getInstance:function(a){return this.cache.use(a.__GUID__),(this.cache.get("dirty")||this.cache.miss("gradient"))&&this.update(a),this.cache.get("gradient")},update:function(){}});return c}),d("core/matrix2d",["require","glmatrix"],function(a){function b(a){return{configurable:!1,set:function(b){this._array[a]=b,this._dirty=!0},get:function(){return this._array[a]}}}var c=a("glmatrix"),d=c.mat2d,e=function(){return Object.create(f,{m00:b(0),m01:b(1),m10:b(2),m11:b(3),m20:b(4),m21:b(5),_array:{writable:!1,configurable:!1,value:d.create()}})},f={constructor:e,clone:function(){return(new e).copy(this)},copy:function(a){return d.copy(this._array,a._array),this},determinant:function(){return d.determinant(this._array)},identity:function(){return d.identity(this._array),this},invert:function(){return d.invert(this._array,this._array),this},mul:function(a){return d.mul(this._array,this._array,a._array),this},mulLeft:function(a){return d.mul(this._array,a._array,this._array),this},multiply:function(a){return d.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return d.multiply(this._array,a._array,this._array),this},rotate:function(a){return d.rotate(this._array,this._array,a),this},scale:function(a){d.scale(this._array,this._array,a._array)},translate:function(a){d.translate(this._array,this._array,a._array)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return e}),d("2d/style",["require","core/base","_"],function(a){function b(a){return(a||"").replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")}var c=a("core/base");a("_");var d=/([0-9\-]+)\s+([0-9\-]+)\s+([0-9]+)\s+(.+)/,e=c.derive({},{bind:function(a){var c=this.fillStyle||this.fill,e=this.strokeStyle||this.stroke,f=this.globalAlpha||this.alpha,g=this.globalCompositeOperation||this.composite;if(this.shadow){var h=d.exec(b(this.shadow));if(h)var i=parseInt(h[1]),j=parseInt(h[2]),k=h[3],l=h[4]}i=this.shadowOffsetX||i,j=this.shadowOffsetY||j,k=this.shadowBlur||k,l=this.shadowColor||l,void 0!==f&&(a.globalAlpha=f),g&&(a.globalCompositeOperation=g),void 0!==this.lineWidth&&(a.lineWidth=this.lineWidth),void 0!==this.lineCap&&(a.lineCap=this.lineCap),void 0!==this.lineJoin&&(a.lineJoin=this.lineJoin),void 0!==this.miterLimit&&(a.miterLimit=this.miterLimit),void 0!==i&&(a.shadowOffsetX=i),void 0!==j&&(a.shadowOffsetY=j),void 0!==k&&(a.shadowBlur=k),void 0!==l&&(a.shadowColor=l),this.font&&(a.font=this.font),this.textAlign&&(a.textAlign=this.textAlign),this.textBaseline&&(a.textBaseline=this.textBaseline),c&&(a.fillStyle=c.getInstance?c.getInstance(a):c),e&&(a.strokeStyle=e.getInstance?e.getInstance(a):e),this.lineDash&&(a.setLineDash?(a.setLineDash(this.lineDash),"number"==typeof this.lineDashOffset&&(a.lineDashOffset=this.lineDashOffset)):console.warn("Browser does not support setLineDash method"))
}});return e}),d("util/util",["require"],function(){return{genGUID:function(){var a=0;return function(){return++a}}()}}),d("2d/node",["require","core/base","core/vector2","core/matrix2d","./style","util/util"],function(a){var b=a("core/base"),c=a("core/vector2"),d=a("core/matrix2d");a("./style");var e=a("util/util"),f=b.derive(function(){return{__GUID__:e.genGUID(),name:"",boundingBox:{min:new c,max:new c},z:0,style:null,position:new c(0,0),rotation:0,scale:new c(1,1),autoUpdate:!0,transform:new d,transformInverse:new d,_prevRotation:0,visible:!0,children:[],intersectLineWidth:0,clip:!1,fill:!0,stroke:!1,enablePicking:!0}},{updateTransform:function(){var a=this.transform;(this.scale._dirty||this.position._dirty||this.rotation!==this._prevRotation)&&this.autoUpdate&&(a.identity(),a.scale(this.scale),a.rotate(this.rotation),a.translate(this.position),this._prevRotation=this.rotation)},updateTransformInverse:function(){this.transformInverse.copy(this.transform).invert()},intersectBoundingBox:function(a,b){var c=this.boundingBox;return c.min.x<a&&a<c.max.x&&c.min.y<b&&b<c.max.y},add:function(a){a&&(this.children.push(a),a.parent=this)},remove:function(a){a&&this.children.splice(this.children.indexOf(a),1)},draw:null,render:function(a){this.trigger("beforerender",a);var b=this.getSortedRenderQueue();if(a.save(),this.style)if(!this.style instanceof Array)for(var c=0;c<this.style.length;c++)this.style[c].bind(a);else this.style.bind&&this.style.bind(a);this.updateTransform();var d=this.transform._array;a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),this.draw&&(this.trigger("beforedraw",a),this.draw(a),this.trigger("afterdraw",a)),this.clip&&a.clip();for(var c=0;c<b.length;c++)b[c].render(a);a.restore(),this.trigger("afterrender",a)},traverse:function(a){var b=a&&a(this);if(!b)for(var c=this.children,d=0,e=c.length;e>d;d++)c[d].traverse(a)},intersect:function(){},getBoundingRect:function(){return{left:null,top:null,width:null,height:null}},getWidth:function(){},getHeight:function(){},getSortedRenderQueue:function(){var a=this.children.slice();return a.sort(function(a,b){return a.z===b.z?a.__GUID__>b.__GUID__?1:-1:a.z>b.z?1:-1}),a}});return f}),d("2d/picking/pixel",["require","core/base"],function(a){function b(a){var b=a>>16,c=a-(b<<8)>>8,d=a-(b<<16)-(c<<8);return[b,c,d]}function c(a,b,c){return(a<<16)+(b<<8)+c}var d=a("core/base"),e=d.derive(function(){return{layer:null,downSampleRatio:1,offset:1,_canvas:null,_context:null,_imageData:null,_lookupTable:[]}},function(){this.init()},{init:function(){if(this.layer){var a=document.createElement("canvas");a.width=this.layer.canvas.width*this.downSampleRatio,a.height=this.layer.canvas.height*this.downSampleRatio,this.layer.on("resize",function(){a.width=this.layer.canvas.width*this.downSampleRatio,a.height=this.layer.canvas.height*this.downSampleRatio},this),this._canvas=a,this._context=a.getContext("2d")}},setPrecision:function(a){this._canvas.width=this.layer.canvas.width*a,this._canvas.height=this.layer.canvas.height*a,this.downSampleRatio=a},update:function(){var a=this._context;a.clearRect(0,0,this._canvas.width,this._canvas.height),a.save(),a.scale(this.downSampleRatio,this.downSampleRatio),this._lookupTable.length=0,this._renderNode(this.layer,a),a.restore();var b=a.getImageData(0,0,this._canvas.width,this._canvas.height);this._imageData=b.data},_renderNode:function(a,c){c.save(),a.updateTransform();var d=a.transform._array;if(c.transform(d[0],d[1],d[2],d[3],d[4],d[5]),a.clip&&c.clip(),a.draw&&a.enablePicking===!0){var e=this._lookupTable,f=b(e.length+this.offset),g="rgb("+f.join(",")+")";this._lookupTable.push(a),c.fillStyle=g,c.strokeStyle=g,a.draw(c,!0)}for(var h=a.getSortedRenderQueue(),i=0;i<h.length;i++){var j=h[i];this._renderNode(j,c)}c.restore()},pick:function(a,b){var c=this.downSampleRatio;this._canvas.width,this._canvas.height,a=Math.ceil(c*a),b=Math.ceil(c*b);for(var d,e=[this._sample(a,b),this._sample(a-1,b),this._sample(a+1,b),this._sample(a,b-1),this._sample(a,b+1)],f={},g=0,h=0;h<e.length;h++){var i=e[h];f[i]?f[i]++:f[i]=1,f[i]>g&&(g=f[i],d=i)}var i=d-this.offset;if(i&&g>=2){var j=this._lookupTable[i];return j}},_sample:function(a,b){a=Math.max(Math.min(a,this._canvas.width),1),b=Math.max(Math.min(b,this._canvas.height),1);var d=4*((b-1)*this._canvas.width+(a-1)),e=this._imageData,f=e[d],g=e[d+1],h=e[d+2];return c(f,g,h)}});return e}),d("2d/layer",["require","./node","./picking/pixel"],function(a){var b=a("./node"),c=a("./picking/pixel"),d=b.derive(function(){return{canvas:null,ctx:null,width:0,height:0,clearColor:"",enablePicking:!0,picking:null}},function(){this.canvas||(this.canvas=document.createElement("canvas")),this.width?this.canvas.width=this.width:this.width=this.canvas.width,this.height?this.canvas.height=this.height:this.height=this.canvas.height,this.canvas.style.zIndex=this.z,this.ctx=this.canvas.getContext("2d"),this.ctx.__GUID__=this.__GUID__,this.enablePicking&&(this.picking=new c({layer:this}))},{resize:function(a,b){this.canvas.width=a,this.canvas.height=b,this.width=a,this.height=b,this.trigger("resize",a,b)},render:function(){this.clearColor?(this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.width,this.height)):this.ctx.clearRect(0,0,this.width,this.height),b.prototype.render.call(this,this.ctx),this.enablePicking&&this.picking.update()},setZ:function(a){this.z=a,this.canvas.style.zIndex=a}});return d}),d("2d/lineargradient",["require","./gradient","core/vector2"],function(a){var b=a("./gradient"),c=a("core/vector2"),d=b.derive(function(){return{start:new c,end:new c(100,0)}},{update:function(a){for(var b=a.createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y),c=0;c<this.stops.length;c++){var d=this.stops[c];b.addColorStop(d[0],d[1])}this.cache.put("gradient",b)}});return d}),d("2d/pattern",["require","core/base","core/vector2"],function(a){var b=a("core/base");a("core/vector2");var c=b.derive(function(){return{image:null,repetition:"repeat"}},{getInstance:function(a){if(this.cache.use(a.__GUID__),this.cache.get("dirty")||this.cache.miss("pattern")){var b=a.createPattern(this.image,this.repetition);return this.cache.put("pattern",b),b}return this.cache.get("pattern")}});return c}),d("2d/picking/box",function(){}),d("2d/util",["require","core/vector2","glmatrix"],function(a){var b=a("core/vector2"),c=a("glmatrix");c.vec2,new b;var d={fixPos:function(a){return a.x+=.5,a.y+=.5,a},fixPosArray:function(a){for(var b=a.length,c=0;b>c;c++)this.fixPos(a[c]);return a},computeBoundingBox:function(a,b,c){for(var d=a[0].x,e=a[0].x,f=a[0].y,g=a[0].y,h=1;h<a.length;h++){var i=a[h];i.x<d&&(d=i.x),i.x>e&&(e=i.x),i.y<f&&(f=i.y),i.y>g&&(g=i.y)}b.set(d,f),c.set(e,g)},computeCubeBezierBoundingBox:function(a,b,c,e,f,g){var h=d._computeCubeBezierExtremitiesDim(a.x,b.x,c.x,e.x),i=d._computeCubeBezierExtremitiesDim(a.y,b.y,c.y,e.y);h.push(a.x,e.x),i.push(a.y,e.y);var j=Math.min.apply(null,h),k=Math.max.apply(null,h),l=Math.min.apply(null,i),m=Math.max.apply(null,i);f.set(j,l),g.set(k,m)},_computeCubeBezierExtremitiesDim:function(a,b,c,d){var e=[],f=6*c-12*b+6*a,g=9*b+3*d-3*a-9*c,h=3*b-3*a,i=f*f-4*g*h;if(i>0){var j=Math.sqrt(i),k=(-f+j)/(2*g),l=(-f-j)/(2*g);e.push(k,l)}else 0==i&&e.push(-f/(2*g));for(var m=[],n=0;n<e.length;n++){var o=e[n];if(Math.abs(2*g*o+f)>1e-4&&1>o&&o>0){var p=1-o,q=p*p*p*a+3*p*p*o*b+3*p*o*o*c+o*o*o*d;m.push(q)}}return m},computeQuadraticBezierBoundingBox:function(a,c,e,f,g){var h=a.x+e.x-2*c.x;if(0===h)var i=.5;else var i=(a.x-c.x)/h;if(h=a.y+e.y-2*c.y,0===h)var j=.5;else var j=(a.y-c.y)/h;i=Math.max(Math.min(i,1),0),j=Math.max(Math.min(j,1),0);var k=1-i,l=1-j,m=k*k*a.x+2*k*i*c.x+i*i*e.x,n=k*k*a.y+2*k*i*c.y+i*i*e.y,o=l*l*a.x+2*l*j*c.x+j*j*e.x,p=l*l*a.y+2*l*j*c.y+j*j*e.y;return d.computeBoundingBox([a.clone(),e.clone(),new b(m,n),new b(o,p)],f,g)},computeArcBoundingBox:function(){var a=new b,c=new b,e=[new b,new b,new b,new b];return function(b,f,g,h,i,j,k){i=i?1:-1,a.set(Math.cos(g),Math.sin(g)*i).scale(f).add(b),c.set(Math.cos(h),Math.sin(h)*i).scale(f).add(b),g%=2*Math.PI,0>g&&(g+=2*Math.PI),h%=2*Math.PI,0>h&&(h+=2*Math.PI),g>h&&(h+=2*Math.PI);for(var l=0,m=0;h>m;m+=Math.PI/2)m>g&&e[l++].set(Math.cos(m),Math.sin(m)*i).scale(f).add(b);var n=e.slice(0,l);n.push(a,c),d.computeBoundingBox(n,j,k)}}()};return d}),d("2d/shape/path",["require","../node","../util","core/vector2"],function(a){var b=a("../node"),c=a("../util"),d=a("core/vector2"),e=new d,f=new d,g=b.derive(function(){return{segments:[],closePath:!1}},{computeBoundingBox:function(){var a=this.segments.length,b=this.segments,d=this.boundingBox.min,g=this.boundingBox.max;d.set(999999,999999),g.set(-999999,-999999);for(var h=1;a>h;h++)b[h-1].handleOut||b[h].handleIn?(c.computeCubeBezierBoundingBox(b[h-1].point,b[h-1].handleOut||b[h-1].point,b[h].handleIn||b[h].point,b[h].point,e,f),d.min(e),g.max(f)):(d.min(b[h-1].point),d.min(b[h].point),g.max(b[h-1].point),g.max(b[h].point))},draw:function(a){var b=this.segments.length,c=this.segments;a.beginPath(),a.moveTo(c[0].point.x,c[0].point.y);for(var d=1;b>d;d++)if(c[d-1].handleOut||c[d].handleIn){var e=c[d-1].handleOut||c[d-1].point,f=c[d].handleIn||c[d].point;a.bezierCurveTo(e.x,e.y,f.x,f.y,c[d].point.x,c[d].point.y)}else a.lineTo(c[d].point.x,c[d].point.y);if(this.closePath)if(c[b-1].handleOut||c[0].handleIn){var e=c[b-1].handleOut||c[b-1].point,f=c[0].handleIn||c[0].point;a.bezierCurveTo(e.x,e.y,f.x,f.y,c[0].point.x,c[0].point.y)}else a.lineTo(c[0].point.x,c[0].point.y);this.fill&&a.fill(),this.stroke&&a.stroke()},smooth:function(a){function b(a,b,c){return g.copy(b).add(c).scale(.5),g.sub(a).negate()}for(var c=this.segments.length,e=[],f=this.segments,g=new d,h=0;c>h;h++){var i=f[h].point,j=h==c-1?f[0].point:f[h+1].point;e.push((new d).copy(i).add(j).scale(.5))}for(var k=new d,l=new d,m=new d,h=0;c>h;h++){var i=f[h].point,n=e[h],o=0==h?e[c-1]:e[h-1],a=f[h].smoothLevel||a||1;k.copy(n).add(o).scale(.5),l.copy(n).sub(k),m.copy(o).sub(k);var p=b(i,o,n);m.scale(a),l.scale(a),f[h].handleIn?f[h].handleIn.copy(k).add(m).add(p):f[h].handleIn=k.clone().add(m).add(p),f[h].handleOut?f[h].handleOut.copy(k).add(l).add(p):f[h].handleOut=k.clone().add(l).add(p)}},pushPoints:function(a){for(var b=0;b<a.length;b++)this.segments.push({point:a[b],handleIn:null,handleOut:null})}});return g}),d("core/event",["require","./base"],function(a){var b=a("./base"),c=b.derive({cancelBubble:!1},{stopPropagation:function(){this.cancelBubble=!0}});return c.throw=function(a,b,d){var e=new c(d);for(e.type=a,e.target=b;b&&!e.cancelBubble;)e.currentTarget=b,b.trigger(a,e),b=b.parent},c}),d("2d/stage",["require","core/base","./layer","core/event"],function(a){var b=a("core/base"),c=a("./layer"),d=a("core/event"),e=b.derive(function(){return{container:null,width:100,height:100,_layers:[],_layersSorted:[],_mouseOverEl:null}},function(){this.container||(this.container=document.createElement("div")),"absolute"!==this.container.style.position&&"fixed"!==this.container.style.position&&(this.container.style.position="relative"),this.width?this.container.style.width=this.width+"px":this.width=this.container.clientWidth,this.height?this.container.style.height=this.height+"px":this.height=this.container.clientHeight,this.container.addEventListener("click",this._eventProxy.bind(this,"click")),this.container.addEventListener("dblclick",this._eventProxy.bind(this,"dblclick")),this.container.addEventListener("mousemove",this._mouseMoveHandler.bind(this)),this.container.addEventListener("mousedown",this._eventProxy.bind(this,"mousedown")),this.container.addEventListener("mouseup",this._eventProxy.bind(this,"mouseup")),this.container.addEventListener("mouseout",this._mouseOutHandler.bind(this))},{createLayer:function(a){a=a||{},a.width=this.width,a.height=this.height;var b=new c(a);return this.addLayer(b),b},addLayer:function(a){a.resize(this.width,this.height);var b=a.canvas;b.style.position="absolute",b.style.left="0px",b.style.top="0px",this.container.appendChild(a.canvas),this._layers.push(a),this._layersSorted=this._layers.slice().sort(function(a,b){return a.z===b.z?a.__GUID__>b.__GUID__?1:-1:a.z>b.z?1:-1})},removeLayer:function(a){this._layers.splice(this._layers.indexOf(a),1),this.container.removeChild(a.canvas)},resize:function(a,b){this.width=a,this.height=b;for(var c=0;c<this._layers.length;c++)this._layers[c].resize(a,b);this.trigger("resize",a,b)},render:function(){for(var a=0;a<this._layers.length;a++)this._layers[a].render()},_eventProxy:function(a,b){var c=this._findTrigger(b);c&&d.throw(a,c,this._assembleE(b))},_mouseMoveHandler:function(a){var b=this._findTrigger(a);b&&d.throw("mousemove",b,this._assembleE(a)),this._mouseOverEl!==b&&(this._mouseOverEl&&d.throw("mouseout",this._mouseOverEl,this._assembleE(a)),b&&d.throw("mouseover",b,this._assembleE(a)),this._mouseOverEl=b)},_mouseOutHandler:function(a){this._mouseOverEl&&d.throw("mouseout",this._mouseOverEl,this._assembleE(a))},_findTrigger:function(a){for(var b=this.container,c=b.getBoundingClientRect(),d=a.pageX-c.left-document.body.scrollLeft,e=a.pageY-c.top-document.body.scrollTop,f=this._layersSorted.length-1;f>=0;f--){var g=this._layersSorted[f],h=g.picking.pick(d,e);if(h)return h}},_assembleE:function(a){return{pageX:a.pageX,pageY:a.pageY}}});return e}),d("core/vector3",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec3,d=function(a,b,d){return a=a||0,b=b||0,d=d||0,Object.create(e,{x:{configurable:!1,set:function(a){this._array[0]=a,this._dirty=!0},get:function(){return this._array[0]}},y:{configurable:!1,set:function(a){this._array[1]=a,this._dirty=!0},get:function(){return this._array[1]}},z:{configurable:!1,set:function(a){this._array[2]=a,this._dirty=!0},get:function(){return this._array[2]}},_array:{writable:!1,configurable:!1,value:c.fromValues(a,b,d)},_dirty:{configurable:!1,value:!0}})},e={constructor:d,add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b,c){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return vec2.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return vec2.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat3:function(a){return c.transformMat3(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},transformQuat:function(a){return c.transformQuat(this._array,this._array,a._array),this._dirty=!0,this},setEulerFromQuaternion:function(){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return d}),d("3d/boundingbox",["require","core/base","core/vector3"],function(a){var b=a("core/base"),c=a("core/vector3"),d=b.derive(function(){return{min:new c,max:new c}},{updateFromVertices:function(a){if(a.length>0){for(var b=a[0].slice(),c=a[1].slice(),d=1;d<a.length;d++){var e=a[d];b[0]=Math.min(e[0],b[0]),b[1]=Math.min(e[1],b[1]),b[2]=Math.min(e[2],b[2]),c[0]=Math.max(e[0],c[0]),c[1]=Math.max(e[1],c[1]),c[2]=Math.max(e[2],c[2])}this.min.set(b[0],b[1],b[2]),this.max.set(c[0],c[1],c[2])}}});return d}),d("core/quaternion",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.quat,d=function(a,b,d,f){return a=a||0,b=b||0,d=d||0,f="undefined"==typeof f?1:f,Object.create(e,{x:{configurable:!1,set:function(a){this._array[0]=a,this._dirty=!0},get:function(){return this._array[0]}},y:{configurable:!1,set:function(a){this._array[1]=a,this._dirty=!0},get:function(){return this._array[1]}},z:{configurable:!1,set:function(a){this._array[2]=a,this._dirty=!0},get:function(){return this._array[2]}},w:{configurable:!1,set:function(a){this._array[2]=a,this._dirty=!0},get:function(){return this._array[2]}},_array:{writable:!1,configurable:!1,value:c.fromValues(a,b,d,f)},_dirty:{configurable:!1,value:!1}})},e={constructor:d,add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},calculateW:function(){return c.calculateW(this._array,this._array),this._dirty=!0,this},set:function(a,b,c,d){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._array[3]=d,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z,this.w)},conjugate:function(){return c.conjugate(this._array,this._array),this._dirty=!0,this},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},fromMat3:function(a){return c.fromMat3(this._array,a._array),this._dirty=!0,this},fromMat4:function(){var a=b.mat3,d=a.create();return function(b){return a.fromMat4(d,b._array),a.transpose(d,d),c.fromMat3(this._array,d),this._dirty=!0,this}}(),identity:function(){return c.identity(this._array),this._dirty=!0,this},invert:function(){return c.invert(this._array,this._array),this._dirty=!0,this},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},rotateX:function(a){return c.rotateX(this._array,this._array,a),this._dirty=!0,this},rotateY:function(a){return c.rotateY(this._array,this._array,a),this._dirty=!0,this},rotateZ:function(a){return c.rotateZ(this._array,this._array,a),this._dirty=!0,this},setAxisAngle:function(a,b){return c.setAxisAngle(this._array,a._array,b),this._dirty=!0,this},slerp:function(a,b,d){return c.slerp(this._array,a._array,b._array,d),this._dirty=!0,this},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},setFromEuler:function(){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return d}),d("core/matrix4",["require","glmatrix","./vector3"],function(a){function b(a){return{configurable:!1,set:function(b){this._array[a]=b,this._dirty=!0},get:function(){return this._array[a]}}}var c=a("glmatrix"),d=a("./vector3"),e=c.mat4,f=c.vec3,g=c.mat3,h=c.quat,i=function(){var a=new d,c=new d,f=new d;return Object.create(j,{m00:b(0),m01:b(1),m02:b(2),m03:b(3),m10:b(4),m11:b(5),m12:b(6),m13:b(7),m20:b(8),m21:b(9),m22:b(10),m23:b(11),m30:b(12),m31:b(13),m32:b(14),m33:b(15),forward:{configurable:!1,get:function(){var a=this._array;return f.set(a[8],a[9],a[10]),f},set:function(a){var b=this._array,a=a._array;b[8]=a[8],b[9]=a[9],b[10]=a[10]}},up:{configurable:!1,enumerable:!0,get:function(){var a=this._array;return c.set(a[4],a[5],a[6]),c},set:function(a){var b=this._array,a=a._array;b[4]=a[4],b[5]=a[5],b[6]=a[6]}},right:{configurable:!1,get:function(){var b=this._array;return a.set(b[0],b[1],b[2]),a},set:function(a){var b=this._array,a=a._array;b[0]=a[0],b[1]=a[1],b[2]=a[2]}},_array:{writable:!1,configurable:!1,value:e.create()}})},j={constructor:i,adjoint:function(){return e.adjoint(this._array,this._array),this},clone:function(){return(new i).copy(this)},copy:function(a){return e.copy(this._array,a._array),this},determinant:function(){return e.determinant(this._array)},fromQuat:function(a){return e.fromQuat(this._array,a._array),this},fromRotationTranslation:function(a,b){return e.fromRotationTranslation(this._array,a._array,b._array),this},frustum:function(a,b,c,d,f,g){return e.frustum(this._array,a,b,c,d,f,g),this},identity:function(){return e.identity(this._array),this},invert:function(){return e.invert(this._array,this._array),this},lookAt:function(a,b,c){return e.lookAt(this._array,a._array,b._array,c._array),this},mul:function(a){return e.mul(this._array,this._array,a._array),this},mulLeft:function(a){return e.mul(this._array,a._array,this._array),this},multiply:function(a){return e.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return e.multiply(this._array,a._array,this._array),this},ortho:function(a,b,c,d,f,g){return e.ortho(this._array,a,b,c,d,f,g),this},perspective:function(a,b,c,d){return e.perspective(this._array,a,b,c,d),this},rotate:function(a,b){return e.rotate(this._array,this._array,a,b._array),this},rotateX:function(a){return e.rotateX(this._array,this._array,a),this},rotateY:function(a){return e.rotateY(this._array,this._array,a),this},rotateZ:function(a){return e.rotateZ(this._array,this._array,a),this},scale:function(a){return e.scale(this._array,this._array,a._array),this},translate:function(a){return e.translate(this._array,this._array,a._array),this},transpose:function(){return e.transpose(this._array,this._array),this},decomposeMatrix:function(){var a=f.create(),b=f.create(),c=f.create(),d=g.create();return function(e,i,j){var k=this._array;f.set(a,k[0],k[1],k[2]),f.set(b,k[4],k[5],k[6]),f.set(c,k[8],k[9],k[10]),e.x=f.length(a),e.y=f.length(b),e.z=f.length(c),j.set(k[12],k[13],k[14]),g.fromMat4(d,k),g.transpose(d,d),d[0]/=e.x,d[1]/=e.x,d[2]/=e.x,d[3]/=e.y,d[4]/=e.y,d[5]/=e.y,d[6]/=e.z,d[7]/=e.z,d[8]/=e.z,h.fromMat3(i._array,d),i.normalize()}}(),toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return i}),d("core/matrix3",["require","glmatrix"],function(a){function b(a){return{configurable:!1,set:function(b){this._array[a]=b,this._dirty=!0},get:function(){return this._array[a]}}}var c=a("glmatrix"),d=c.mat3,e=function(){return Object.create(f,{m00:b(0),m01:b(1),m02:b(2),m10:b(3),m11:b(4),m12:b(5),m20:b(6),m21:b(7),m22:b(8),_array:{writable:!1,configurable:!1,value:d.create()}})},f={constructor:e,adjoint:function(){return d.adjoint(this._array,this._array),this},clone:function(){return(new e).copy(this)},copy:function(a){return d.copy(this._array,a._array),this},determinant:function(){return d.determinant(this._array)},fromMat2d:function(a){return d.fromMat2d(this._array,a._array)},fromMat4:function(a){return d.fromMat4(this._array,a._array)},fromQuat:function(a){return d.fromQuat(this._array,a._array),this},identity:function(){return d.identity(this._array),this},invert:function(){return d.invert(this._array,this._array),this},mul:function(a){return d.mul(this._array,this._array,a._array),this},mulLeft:function(a){return d.mul(this._array,a._array,this._array),this},multiply:function(a){return d.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return d.multiply(this._array,a._array,this._array),this},normalFromMat4:function(a){return d.normalFromMat4(this._array,a._array),this},transpose:function(){return d.transpose(this._array,this._array),this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return e}),d("3d/node",["require","core/base","core/vector3","./boundingbox","core/quaternion","core/matrix4","core/matrix3","util/util","_"],function(a){var b=a("core/base"),c=a("core/vector3"),d=a("./boundingbox"),e=a("core/quaternion"),f=a("core/matrix4");a("core/matrix3");var g=a("util/util"),h=a("_"),i=b.derive(function(){var a=g.genGUID();return{__GUID__:a,name:"NODE_"+a,visible:!0,position:new c,rotation:new e,scale:new c(1,1,1),eulerAngle:new c,useEuler:!1,children:[],parent:null,worldMatrix:new f,matrix:new f,boundingBox:new d}},{add:function(a){if(!(this.children.indexOf(a)>=0)){this.children.push(a),a.parent=this;var b=this.getScene();b&&a.traverse(function(a){b.addToScene(a)})}},remove:function(a){h.without(this.children,a),a.parent=null;var b=this.getScene();b&&a.traverse(function(a){b.removeFromScene(a)})},getScene:function(){for(var a=this;a.parent;)a=a.parent;return a.addToScene?a:void 0},traverse:function(a){var b=a&&a(this);if(!b)for(var c=this.children,d=0,e=c.length;e>d;d++)c[d].traverse(a)},updateMatrix:function(){if(!this.position._dirty&&!this.scale._dirty){if(this.useEuler&&!this.eulerAngle._dirty)return;if(!this.rotation._dirty)return}var a=this.matrix;a.identity(),this.useEuler&&(this.rotation.identity(),this.rotation.rotateX(this.eulerAngle.x),this.rotation.rotateY(this.eulerAngle.y),this.rotation.rotateZ(this.eulerAngle.z)),a.fromRotationTranslation(this.rotation,this.position),a.scale(this.scale),this.rotation._dirty=!1,this.scale._dirty=!1,this.position._dirty=!1,this.eulerAngle._dirty=!1},decomposeMatrix:function(){this.matrix.decomposeMatrix(this.scale,this.rotation,this.position),this.useEuler||this.eulerAngle.setEulerFromQuaternion(this.rotation),this.rotation._dirty=!1,this.scale._dirty=!1,this.position._dirty=!1,this.eulerAngle._dirty=!1},updateWorldMatrix:function(){this.updateMatrix(),this.parent?this.worldMatrix.copy(this.parent.worldMatrix).multiply(this.matrix):this.worldMatrix.copy(this.matrix)},update:function(a,b){b||this.trigger("beforeupdate",a),this.updateWorldMatrix();for(var c=0;c<this.children.length;c++){var d=this.children[c];d.visible&&d.update(a)}b||this.trigger("afterupdate",a)},getWorldPosition:function(){var a=this.worldMatrix._array;return new c(a[12],a[13],a[14])},translate:function(a){this.updateMatrix(),this.translate(a),this.decomposeMatrix()},rotate:function(a,b){this.updateMatrix(),this.matrix.rotate(a,b),this.decomposeMatrix()},rotateAround:function(){var a=new c,b=new f;return function(c,d,e){a.copy(this.position).subtract(c),this.matrix.identity(),this.matrix.translate(c),this.matrix.rotate(e,d),this.useEuler&&(this.rotation.identity(),this.rotation.rotateX(this.eulerAngle.x),this.rotation.rotateY(this.eulerAngle.y),this.rotation.rotateZ(this.eulerAngle.z)),b.fromRotationTranslation(this.rotation,a),this.matrix.multiply(b),this.matrix.scale(this.scale),this.decomposeMatrix()}}(),lookAt:function(){var a=new f,b=new c;return function(c,d){a.lookAt(this.position,c,d||this.matrix.up).invert(),a.decomposeMatrix(b,this.rotation,this.position)}}()});return i}),d("3d/bone",["require","./node","core/quaternion","core/vector3","core/matrix4"],function(a){var b=a("./node");a("core/quaternion"),a("core/vector3"),a("core/matrix4");var c=b.derive(function(){return{index:-1,parentIndex:-1,poses:[],_prevKey:0,_prevTime:0}},{setPose:function(a){this._interpolateField(a,"position"),this._interpolateField(a,"rotation"),this._interpolateField(a,"scale")},_interpolateField:function(a,b){for(var c,d,e=this.poses,f=e.length,g=0;f>g;g++)if(e[g].time<=a&&e[g][b])c=e[g];else if(e[g][b]){d=e[g];break}if(c&&d){var h=(a-c.time)/(d.time-c.time);h=Math.max(Math.min(h,1),0),"rotation"===b?this[b].slerp(c[b],d[b],h):this[b].lerp(c[b],d[b],h)}}});return c}),d("3d/camera",["require","./node","core/matrix4"],function(a){var b=a("./node"),c=a("core/matrix4"),d=b.derive(function(){return{projectionMatrix:new c}},function(){this.update()},{update:function(a){b.prototype.update.call(this,a),this.updateProjectionMatrix()}});return d}),d("3d/camera/perspective",["require","../camera"],function(a){var b=a("../camera"),c=b.derive(function(){return{fov:50,aspect:1,near:.1,far:2e3}},{updateProjectionMatrix:function(){var a=this.fov/180*Math.PI;this.projectionMatrix.perspective(a,this.aspect,this.near,this.far)}});return c}),d("3d/compositor/graph",["require","core/base","_"],function(a){var b=a("core/base"),c=a("_"),d=b.derive(function(){return{nodes:[]}},{add:function(a){this.nodes.push(a),this._dirty=!0},remove:function(a){c.without(this.nodes,a),this._dirty=!0},update:function(){for(var a=0;a<this.nodes.length;a++)this.nodes[a].clear();for(var a=0;a<this.nodes.length;a++){var b=this.nodes[a];if(b.inputs)for(var c in b.inputs){var d=b.inputs[c],e=this.findPin(d);e?b.link(c,e.node,e.pin):console.warn("Pin of "+d.node+"."+d.pin+" not exist")}}},findPin:function(a){var b;if("string"==typeof a.node)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c];d.name===a.node&&(b=d)}else b=a.node;return b&&b.outputs[a.pin]?{node:b,pin:a.pin}:void 0},fromJSON:function(){}});return d}),d("3d/compositor",["require","./compositor/graph"],function(a){var b=a("./compositor/graph"),c=b.derive(function(){return{_outputs:[]}},{render:function(a){this._dirty&&(this.update(),this._dirty=!1);for(var b=0;b<this.nodes.length;b++){var c=this.nodes[b];this._outputs.length||c.outputs||c.render(a),c.updateReference()}for(var b=0;b<this._outputs.length;b++)this._outputs[b].render(a)},setOutput:function(a){this._outputs.push(a)},unsetOutput:function(a){this._outputs.splice(this._outputs.indexOf(a),1)}});return c}),d("3d/scene",["require","./node"],function(a){var b=a("./node"),c=b.derive(function(){return{material:null,lightNumber:{},lightUniforms:{},filter:null,_nodeRepository:{}}},{addToScene:function(a){a.name&&(this._nodeRepository[a.name]=a)},removeFromScene:function(a){a.name&&(this._nodeRepository[a.name]=null)},getNode:function(a){return this._nodeRepository[a]}});return c}),d("3d/camera/orthographic",["require","../camera"],function(a){var b=a("../camera"),c=b.derive(function(){return{left:-1,right:1,near:0,far:1,top:1,bottom:-1}},{updateProjectionMatrix:function(){this.projectionMatrix.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)}});return c}),d("3d/geometry",["require","core/base","core/vector3","./boundingbox","util/util","glmatrix","_"],function(a){var b=a("core/base");a("core/vector3");var c=a("./boundingbox"),d=a("util/util"),e=a("glmatrix"),f=e.vec3;e.vec2,e.mat2;var g=e.mat4;a("_");var h=Array.prototype.slice,i=b.derive(function(){return{__GUID__:d.genGUID(),attributes:{position:{type:"float",semantic:"POSITION",size:3,value:[]},texcoord0:{type:"float",semantic:"TEXCOORD_0",size:2,value:[]},texcoord1:{type:"float",semantic:"TEXCOORD_1",size:2,value:[]},normal:{type:"float",semantic:"NORMAL",size:3,value:[]},tangent:{type:"float",semantic:"TANGENT",size:4,value:[]},color:{type:"ubyte",semantic:"COLOR",size:3,value:[]},barycentric:{type:"float",size:3,value:[]},boneWeight:{type:"float",size:3,value:[]},boneIndex:{type:"float",size:4,value:[]}},boundingBox:new c,useFace:!0,faces:[],hint:"STATIC_DRAW",chunkSize:65535,_enabledAttributes:null,_normalType:"vertex",_arrayChunks:[],_verticesReorganizedMap:[],_reorganizedFaces:[]}},{computeBoundingBox:function(){},dirty:function(a){if(a)this.cache.dirtyAll(a),this._enabledAttributes=null;else{this.dirty("indices");for(var b in this.attributes)this.dirty(b)}},getVerticesNumber:function(){return this.attributes.position.value.length},isUseFace:function(){return this.useFace&&this.faces.length>0},_getEnabledAttributes:function(){if(this._enabledAttributes)return this._enabledAttributes;
var a={},b=this.getVerticesNumber();for(var c in this.attributes){var d=this.attributes[c];d.value&&d.value.length&&d.value.length===b&&(a[c]=d)}return this._enabledAttributes=a,a},_getDirtyAttributes:function(){var a={},b=this._getEnabledAttributes(),c=!0;for(var d in b)b[d],(this.cache.get("dirty_"+d)||this.cache.miss("dirty_"+d))&&(a[d]=b[d],c=!1);return c?void 0:a},getChunkNumber:function(){return this._arrayChunks.length},getBufferChunks:function(a){this.cache.use(a.__GUID__);var b=this.cache.getContext(),c=this._getDirtyAttributes(),d=this.cache.get("dirty_face")||this.cache.miss("dirty_face");if(d=d&&this.isUseFace(),c){this._updateAttributesAndIndicesArrays(c,d),this._updateBuffer(a,c,d);for(var e in c)b["dirty_"+e]=!1;b.dirty_face=!1}return this.cache.get("chunks")},_updateAttributesAndIndicesArrays:function(a,b){var c=this,d={},e=this.getVerticesNumber(),f=this._verticesReorganizedMap,g={};for(var h in a){switch(K){case"byte":g[h]=Int8Array;break;case"ubyte":g[h]=Uint8Array;break;case"short":g[h]=Int16Array;break;case"ushort":g[h]=Uint16Array;break;default:g[h]=Float32Array}d[h]=0}var i=function(b){if(c._arrayChunks[b])return c._arrayChunks[b];var g={attributeArrays:{},indicesArray:null};for(var h in a)g.attributeArrays[h]=null;for(var h in d)d[h]=0;for(var i=0;e>i;i++)f[i]=-1;return c._arrayChunks.push(g),g},j=Object.keys(a);if(e>this.chunkSize&&this.isUseFace()){var k,l=0,m=0,n=[0],o=[];for(p=0;e>p;p++)o[p]=-1,f[p]=-1;if(b&&this._reorganizedFaces.length!==this.faces.length)for(p=0;p<this.faces.length;p++)this._reorganizedFaces[p]=[0,0,0];k=i(m);for(var p=0;p<this.faces.length;p++){var q=this.faces[p],r=this._reorganizedFaces[p],s=q[0],t=q[1],u=q[2];l+3>this.chunkSize&&(m++,n[m]=p,l=0,k=i(m));for(var v=-1===f[s],w=-1===f[t],x=-1===f[u],y=0;y<j.length;y++){var h=j[y],z=k.attributeArrays[h],A=a[h].value,B=a[h].size;if(z||(z=k.attributeArrays[h]=[]),1===B)v&&(z[d[h]++]=A[s]),w&&(z[d[h]++]=A[t]),x&&(z[d[h]++]=A[u]);else{if(v)for(var C=0;B>C;C++)z[d[h]++]=A[s][C];if(w)for(var C=0;B>C;C++)z[d[h]++]=A[t][C];if(x)for(var C=0;B>C;C++)z[d[h]++]=A[u][C]}}v?(f[s]=l,r[0]=l,l++):r[0]=f[s],w?(f[t]=l,r[1]=l,l++):r[1]=f[t],x?(f[u]=l,r[2]=l,l++):r[2]=f[u]}for(var D=0;D<this._arrayChunks.length;D++){var E=this._arrayChunks[D];for(var h in E.attributeArrays){var F=E.attributeArrays[h];F instanceof Array&&(E.attributeArrays[h]=new g[h](F))}}if(b)for(var G,H,I,E,D=0;D<this._arrayChunks.length;D++){G=n[D],H=n[D+1]||this.faces.length,I=0,E=this._arrayChunks[D];var J=E.indicesArray;J||(J=E.indicesArray=new Uint16Array(3*(H-G)));for(var p=G;H>p;p++)J[I++]=this._reorganizedFaces[p][0],J[I++]=this._reorganizedFaces[p][1],J[I++]=this._reorganizedFaces[p][2]}}else{var E=i(0);if(b){var J=E.indicesArray;J||(J=E.indicesArray=new Uint16Array(3*this.faces.length));for(var I=0,p=0;p<this.faces.length;p++)J[I++]=this.faces[p][0],J[I++]=this.faces[p][1],J[I++]=this.faces[p][2]}for(var h in a){var A=a[h].value,K=a[h].type,B=a[h].size,z=E.attributeArrays[h];if(z||(z=E.attributeArrays[h]=new g[h](e*B)),1===B)for(var p=0;p<A.length;p++)z[p]=A[p];else for(var I=0,p=0;p<A.length;p++)for(var C=0;B>C;C++)z[I++]=A[p][C]}}},_updateBuffer:function(a,b,c){var d=this.cache.get("chunks");if(!d){d=[];for(var e=0;e<this._arrayChunks.length;e++)d[e]={attributeBuffers:{},indicesBuffer:null};this.cache.put("chunks",d)}for(var e=0;e<d.length;e++){var f=d[e];f||(f=d[e]={attributeBuffers:{},indicesBuffer:null});var g=f.attributeBuffers,h=f.indicesBuffer,i=this._arrayChunks[e],j=i.attributeArrays,k=i.indicesArray;for(var l in b){var m,n=b[l],o=n.type,p=n.semantic,q=n.size,r=g[l];m=r?r.buffer:a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,m),a.bufferData(a.ARRAY_BUFFER,j[l],a[this.hint]),g[l]={type:o,buffer:m,size:q,semantic:p}}c&&(h||(h=f.indicesBuffer={buffer:a.createBuffer(),count:k.length}),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h.buffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,k,a[this.hint]))}},generateVertexNormals:function(){var a=this.faces,b=(a.length,this.attributes.position.value),c=this.attributes.normal.value,d=f.create();v12=f.create(),v23=f.create(),b.length-c.length;for(var e=0;e<c.length;e++)f.set(c[e],0,0,0);for(var e=c.length;e<b.length;e++)c[e]=[0,0,0];for(var g=0;g<this.faces.length;g++){var h=a[g],i=h[0],j=h[1],k=h[2],l=b[i],m=b[j],n=b[k];f.sub(v12,l,m),f.sub(v23,m,n),f.cross(d,v12,v23),f.add(c[i],c[i],d),f.add(c[j],c[j],d),f.add(c[k],c[k],d)}for(var e=0;e<c.length;e++)f.normalize(c[e],c[e]);this._normalType="vertex"},generateFaceNormals:function(){this.isUniqueVertex()||this.generateUniqueVertex();var a=this.faces,b=a.length,c=this.attributes.position.value,d=this.attributes.normal.value,e=f.create();v12=f.create(),v23=f.create();for(var g=d.length===c.length,i=0;b>i;i++){var j=a[i],k=j[0],l=j[1],m=j[2],n=c[k],o=c[l],p=c[m];f.sub(v12,n,o),f.sub(v23,o,p),f.cross(e,v12,v23),g?(f.copy(d[k],e),f.copy(d[l],e),f.copy(d[m],e)):d[k]=d[l]=d[m]=h.call(e)}this._normalType="face"},generateTangents:function(){for(var a=this.attributes.texcoord0.value,b=this.attributes.position.value,c=this.attributes.tangent.value,d=this.attributes.normal.value,e=[],g=[],h=this.getVerticesNumber(),i=0;h>i;i++)e[i]=[0,0,0],g[i]=[0,0,0];for(var j=[0,0,0],k=[0,0,0],i=0;i<this.faces.length;i++){var l=this.faces[i],m=l[0],n=l[1],o=l[2],p=a[m],q=a[n],r=a[o],s=b[m],t=b[n],u=b[o],v=t[0]-s[0],w=u[0]-s[0],x=t[1]-s[1],y=u[1]-s[1],z=t[2]-s[2],A=u[2]-s[2],B=q[0]-p[0],C=r[0]-p[0],D=q[1]-p[1],E=r[1]-p[1],F=1/(B*E-D*C);j[0]=(E*v-D*w)*F,j[1]=(E*x-D*y)*F,j[2]=(E*z-D*A)*F,k[0]=(B*w-C*v)*F,k[1]=(B*y-C*x)*F,k[2]=(B*A-C*z)*F,f.add(e[m],e[m],j),f.add(e[n],e[n],j),f.add(e[o],e[o],j),f.add(g[m],g[m],k),f.add(g[n],g[n],k),f.add(g[o],g[o],k)}for(var G=[0,0,0,0],H=[0,0,0],i=0;h>i;i++){var I=d[i],J=e[i];f.scale(G,I,f.dot(I,J)),f.sub(G,J,G),f.normalize(G,G),f.cross(H,I,J),G[3]=f.dot(H,g[i])<0?-1:1,c[i]=G.slice()}},isUniqueVertex:function(){return this.isUseFace()?this.getVerticesNumber()===3*this.faces.length:!0},generateUniqueVertex:function(){function a(a){for(var b in e){var c=e[b].value,d=c[0].length||1;1===d?c.push(c[a]):c.push(h.call(c[a]))}}for(var b=[],c=0;c<this.getVerticesNumber();c++)b[c]=0;for(var d=this.getVerticesNumber(),e=this._getEnabledAttributes(),f=this.faces,c=0;c<f.length;c++){var g=f[c],i=g[0],j=g[1],k=g[2];b[i]>0&&(a(i),g[0]=d,d++),b[j]>0&&(a(j),g[1]=d,d++),b[k]>0&&(a(k),g[2]=d,d++),b[i]++,b[j]++,b[k]++}this.dirty()},generateBarycentric:function(){var a=[1,0,0],b=[0,0,1],c=[0,1,0];return function(){this.isUniqueVertex()||this.generateUniqueVertex();var d=this.attributes.barycentric.value;if(d.length!=3*this.faces.length)for(var e,f,g,h,i=0;i<this.faces.length;i++)h=this.faces[i],e=h[0],f=h[1],g=h[2],d[e]=a,d[f]=b,d[g]=c}}(),applyMatrix:function(a){var b=this.attributes.position.value,c=this.attributes.normal.value;a=a._array;for(var d=0;d<b.length;d++)f.transformMat4(b[d],b[d],a);var e=g.create();g.invert(e,a),g.transpose(e,e);for(var d=0;d<c.length;d++)f.transformMat4(c[d],c[d],e)},dispose:function(){}});return i}),d("3d/geometry/plane",["require","../geometry"],function(a){var b=a("../geometry"),c=b.derive(function(){return{widthSegments:1,heightSegments:1}},function(){for(var a=this.heightSegments,b=this.widthSegments,c=this.attributes.position.value,d=this.attributes.texcoord0.value,e=this.attributes.normal.value,f=this.faces,g=0;a>=g;g++)for(var h=g/a,i=0;b>=i;i++){var j=i/b;if(c.push([2*j-1,2*h-1,0]),d&&d.push([j,h]),e&&e.push([0,0,1]),b>i&&a>g){var k=i+g*(b+1);f.push([k,k+1,k+b+1]),f.push([k+b+1,k+1,k+b+2])}}});return c}),d("3d/shader",["require","core/base","glmatrix","util/util","_"],function(a){function b(a){for(var b=a.split("\n"),c=0,d=b.length;d>c;c++)b[c]=c+1+": "+b[c];return b.join("\n")}var c=a("core/base"),d=a("glmatrix"),e=d.mat2;mat3=d.mat3,mat4=d.mat4,util=a("util/util"),_=a("_");var f=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+(\w+)?(\[.*?\])?\s*(:\s*([\S\s]+?))?;/g,g=/attribute\s+(float|int|vec2|vec3|vec4)\s+(\w*)\s*(:\s*(\w+))?;/g,h={bool:"1i","int":"1i",sampler2D:"t",samplerCube:"t","float":"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"},i={bool:function(){return!0},"int":function(){return 0},"float":function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return new Float32Array(2)},vec3:function(){return new Float32Array(3)},vec4:function(){return new Float32Array(4)},ivec2:function(){return new Int32Array(2)},ivec3:function(){return new Int32Array(3)},ivec4:function(){return new Int32Array(4)},mat2:function(){return e.create()},mat3:function(){return mat3.create()},mat4:function(){return mat4.create()},array:function(){return[]}},j=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],k={},l={},m=c.derive(function(){return{__GUID__:util.genGUID(),vertex:"",fragment:"",precision:"mediump",semantics:{},uniformTemplates:{},attributeTemplates:{},vertexDefines:{},fragmentDefines:{},lightNumber:{},_textureStatus:{},_vertexProcessed:"",_fragmentProcessed:"",_program:null}},function(){this.updateShaderString()},{setVertex:function(a){this.vertex=a,this.dirty()},setFragment:function(a){this.fragment=a,this.dirty()},bind:function(a){this.cache.use(a.__GUID__,{locations:{},attriblocations:{}}),this.cache.isDirty()&&(this.updateShaderString(),this._buildProgram(a,this._vertexProcessed,this._fragmentProcessed),this.cache.fresh()),a.useProgram(this.cache.get("program"))},dirty:function(){this.cache.dirty();for(var a in this.cache._caches){var b=this.cache._caches[a];b.locations={},b.attriblocations={}}},updateShaderString:function(a){(this.vertex!==this._vertexPrev||this.fragment!==this._fragmentPrev||a)&&(this._parseImport(),this.semantics={},this._textureStatus={},this._parseUniforms(),this._parseAttributes(),this._vertexPrev=this.vertex,this._fragmentPrev=this.fragment),this._addDefine()},define:function(a,b,c){switch(c=c||null,a){case"vertex":this.vertexDefines[b]!==c&&(this.vertexDefines[b]=c,this.dirty());break;case"fragment":this.fragmentDefines[b]!==c&&(this.fragmentDefines[b]=c,this.dirty());break;default:console.warn("Define type must be vertex or fragment")}},unDefine:function(a,b){switch(a){case"vertex":this.isDefined("vertex",b)&&(delete this.vertexDefines[b],this.dirty());break;case"fragment":this.isDefined("fragment",b)&&(delete this.fragmentDefines[b],this.dirty());break;default:console.warn("Define type must be vertex or fragment")}},isDefined:function(a,b){switch(a){case"vertex":return void 0!==this.vertexDefines[b];case"fragment":return void 0!==this.fragmentDefines[b]}},getDefine:function(a,b){switch(a){case"vertex":return this.vertexDefines[b];case"fragment":return this.fragmentDefines[b]}},enableTexture:function(a){var b=this._textureStatus[a];if(b){var c=b.enabled;if(c)return;b.enabled=!0,this.dirty()}},enableTexturesAll:function(){for(var a in this._textureStatus)this._textureStatus[a].enabled=!0;this.dirty()},disableTexture:function(a){var b=this._textureStatus[a];if(b){var c=!b.enabled;if(c)return;b.enabled=!1,this.dirty()}},disableTexturesAll:function(a){for(var a in this._textureStatus)this._textureStatus[a].enabled=!1;this.dirty()},setUniform:function(a,b,c,d){var e=this.cache.get("program"),f=this.cache.get("locations"),g=f[c];if(null!==g){if(!g){if(g=a.getUniformLocation(e,c),null===g)return f[c]=null,void 0;f[c]=g}switch(b){case"1i":a.uniform1i(g,d);break;case"1f":a.uniform1f(g,d);break;case"1fv":a.uniform1fv(g,d);break;case"1iv":a.uniform1iv(g,d);break;case"2iv":a.uniform2iv(g,d);break;case"2fv":a.uniform2fv(g,d);break;case"3iv":a.uniform3iv(g,d);break;case"3fv":a.uniform3fv(g,d);break;case"4iv":a.uniform4iv(g,d);break;case"4fv":a.uniform4fv(g,d);break;case"2i":a.uniform2i(g,d[0],d[1]);break;case"2f":a.uniform2f(g,d[0],d[1]);break;case"3i":a.uniform3i(g,d[0],d[1],d[2]);break;case"3f":a.uniform3f(g,d[0],d[1],d[2]);break;case"4i":a.uniform4i(g,d[0],d[1],d[2],d[3]);break;case"4f":a.uniform4f(g,d[0],d[1],d[2],d[3]);break;case"m2":a.uniformMatrix2fv(g,!1,d);break;case"m3":a.uniformMatrix3fv(g,!1,d);break;case"m4":a.uniformMatrix4fv(g,!1,d);break;case"m2v":var h=4;case"m3v":var h=9;case"m4v":var h=16;if(d instanceof Array){for(var i=new Float32Array(d.length*h),j=0,k=0;k<d.length;k++)for(var l=d[k],m=0;m<l.length;m++)i[j++]=l[m];a.uniformMatrix4fv(g,!1,i)}else d instanceof Float32Array&&a.uniformMatrix4fv(g,!1,d)}}},enableAttributes:function(a,b){var c=this.cache.get("program"),d=this.cache.get("attriblocations");"string"==typeof b&&(b=Array.prototype.slice.call(arguments,1));var e=l[a.__GUID__];e||(e=l[a.__GUID__]=[]);for(var f=0;f<b.length;f++){var g=b[f];if(this.attributeTemplates[g]){var h=d[g];if("undefined"==typeof h){if(h=a.getAttribLocation(c,g),-1===h)continue;d[g]=h}e[h]=e[h]?3:2}}for(var f=0;f<e.length;f++)switch(e[f]){case 2:a.enableVertexAttribArray(f),e[f]=1;break;case 3:e[f]=1;break;case 1:a.disableVertexAttribArray(f),e[f]=0}},setMeshAttribute:function(a,b,c,d){var e;switch(c){case"byte":e=a.BYTE;break;case"ubyte":e=a.UNSIGNED_BYTE;break;case"short":e=a.SHORT;break;case"ushort":e=a.UNSIGNED_SHORT;break;default:e=a.FLOAT}var f=this.cache.get("program"),g=this.cache.get("attriblocations"),h=g[b];if("undefined"==typeof h){if(h=a.getAttribLocation(f,b),-1===h)return;g[b]=h}a.vertexAttribPointer(h,d,e,!1,0,0)},_parseImport:function(){this._vertexProcessedWithoutDefine=m.parseImport(this.vertex),this._fragmentProcessedWithoutDefine=m.parseImport(this.fragment)},_addDefine:function(){var a=[];_.each(this.lightNumber,function(b,c){b&&a.push("#define "+c.toUpperCase()+"_NUMBER "+b)}),_.each(this._textureStatus,function(b,c){b.enabled&&"vertex"===b.shaderType&&a.push("#define "+c.toUpperCase()+"_ENABLED")}),_.each(this.vertexDefines,function(b,c){null===b?a.push("#define "+c):a.push("#define "+c+" "+b.toString())}),this._vertexProcessed=a.join("\n")+"\n"+this._vertexProcessedWithoutDefine,a=[],_.each(this.lightNumber,function(b,c){b&&a.push("#define "+c+"_NUMBER "+b)}),_.each(this._textureStatus,function(b,c){b.enabled&&"fragment"===b.shaderType&&a.push("#define "+c.toUpperCase()+"_ENABLED")}),_.each(this.fragmentDefines,function(b,c){null===b?a.push("#define "+c):a.push("#define "+c+" "+b.toString())});var b=a.join("\n")+"\n"+this._fragmentProcessedWithoutDefine;this._fragmentProcessed=["precision",this.precision,"float"].join(" ")+";\n"+b},_parseUniforms:function(){function a(a,e,f,g,k,l){if(e&&f){var m=h[e],n=!0;if(m){if(("sampler2D"===e||"samplerCube"===e)&&(c._textureStatus[f]={enabled:!1,shaderType:d}),g&&(m+="v"),l)if(j.indexOf(l)<0)if("unconfigurable"===l)n=!1;else{var o=c._parseDefaultValue(e,l);o?l="":console.warn('Unkown semantic "'+l+'"')}else c.semantics[l]={symbol:f,type:m},n=!1;n&&(b[f]={type:m,value:g?i.array:o||i[e],semantic:l||null})}return["uniform",e,f,g].join(" ")+";\n"}}var b={},c=this,d="vertex";this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(f,a),d="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(f,a),this.uniformTemplates=b},_parseDefaultValue:function(a,b){var c=/\[\s*(.*)\s*\]/;{if("vec2"!==a&&"vec3"!==a&&"vec4"!==a)return"bool"===a?function(){return"true"===b.toLowerCase()?!0:!1}:"float"===a?function(){return parseFloat(b)}:void 0;var d=c.exec(b)[1];if(d){var e=d.split(/\s*,\s*/);return function(){return new Float32Array(e)}}}},createUniforms:function(){var a={};return _.each(this.uniformTemplates,function(b,c){a[c]={type:b.type,value:b.value()}}),a},_parseAttributes:function(){function a(a,d,e,f,g){if(d&&e){var h=1;switch(d){case"vec4":h=4;break;case"vec3":h=3;break;case"vec2":h=2;break;case"float":h=1}b[e]={type:"float",size:h,semantic:g||null},g&&(j.indexOf(g)<0?console.warn('Unkown semantic "'+g+'"'):c.semantics[g]={symbol:e,type:d})}return["attribute",d,e].join(" ")+";\n"}var b={},c=this;this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(g,a),this.attributeTemplates=b},_buildProgram:function(a,b,c){this.cache.get("program")&&a.deleteProgram(this.cache.get("program"));var d=a.createProgram();try{var e=this._compileShader(a,"vertex",b),f=this._compileShader(a,"fragment",c);if(a.attachShader(d,e),a.attachShader(d,f),a.linkProgram(d),!a.getProgramParameter(d,a.LINK_STATUS))throw new Error("Could not initialize shader\nVALIDATE_STATUS: "+a.getProgramParameter(d,a.VALIDATE_STATUS)+", gl error ["+a.getError()+"]")}catch(g){if(k[this.__GUID__])return;throw k[this.__GUID__]=this,g}a.deleteShader(e),a.deleteShader(f),this.cache.put("program",d)},_compileShader:function(a,c,d){var e=a.createShader("fragment"===c?a.FRAGMENT_SHADER:a.VERTEX_SHADER);if(a.shaderSource(e,d),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS))throw new Error([a.getShaderInfoLog(e),b(d)].join("\n"));return e},dispose:function(){}}),n=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;m.parseImport=function(a){return a=a.replace(n,function(a,b,c){return p[c]?m.parseImport(p[c]):void 0})};var o=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;m.import=function(a){a.replace(o,function(a,b,c,d){return p[c]=d,d})};var p={};return m.source=function(a){var b=p[a];return b?b:(console.error('Shader "'+a+'" not existed in library'),void 0)},m}),d("3d/texture",["require","core/base","_"],function(a){var b=a("core/base");a("_");var c=b.derive(function(){return{width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1,dynamic:!1,NPOT:!1}},{getWebGLTexture:function(a){return this.cache.use(a.__GUID__),this.cache.miss("webgl_texture")&&this.cache.put("webgl_texture",a.createTexture()),this.dynamic?this.update(a):this.cache.isDirty()&&(this.update(a),this.cache.fresh()),this.cache.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){this.cache.dirtyAll()},update:function(){},beforeUpdate:function(a){a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,this.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,this.unpackAlignment),this.fallBack()},fallBack:function(){var a=this.isPowerOfTwo();"DEPTH_COMPONENT"===this.format&&(this.useMipmap=!1),a&&this.useMipmap?(this._minFilterOriginal&&(this.minFilter=this._minFilterOriginal),this._magFilterOriginal&&(this.magFilter=this._magFilterOriginal),this._wrapSOriginal&&(this.wrapS=this._wrapSOriginal),this._wrapTOriginal&&(this.wrapT=this._wrapTOriginal)):(this.NPOT=!0,this._minFilterOriginal=this.minFilter,this._magFilterOriginal=this.magFilter,this._wrapSOriginal=this.wrapS,this._wrapTOriginal=this.wrapT,this.minFilter=0==this.minFilter.indexOf("NEAREST")?"NEAREST":"LINEAR",this.magFilter=0==this.magFilter.indexOf("NEAREST")?"NEAREST":"LINEAR",this.wrapS="CLAMP_TO_EDGE",this.wrapT="CLAMP_TO_EDGE")},nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},dispose:function(a){this.cache.use(a.__GUID__),a.deleteTexture(this.cache.get("webgl_texture"))},isRenderable:function(){},isPowerOfTwo:function(){}});return c}),d("3d/webglinfo",[],function(){var a=["OES_texture_float","OES_texture_half_float","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_draw_buffers"],b={},c={initialize:function(c){if(!b[c.__GUID__]){b[c.__GUID__]={};for(var d=0;d<a.length;d++){var e=a[d],f=c.getExtension(e);f||(f=c.getExtension("MOZ_"+e)),f||(f=c.getExtension("WEBKIT_"+e)),b[c.__GUID__][e]=f}}},getExtension:function(a,c){var d=a.__GUID__;return b[d]?b[d][c]:void 0}};return c}),d("3d/texture/texture2d",["require","../texture","../webglinfo"],function(a){var b=a("../texture"),c=a("../webglinfo"),d=b.derive({image:null,pixels:null},{update:function(a){a.bindTexture(a.TEXTURE_2D,this.cache.get("webgl_texture")),this.beforeUpdate(a);var b=a[this.format.toUpperCase()],d=a[this.type.toUpperCase()];a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a[this.wrapS.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a[this.wrapT.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a[this.magFilter.toUpperCase()]),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a[this.minFilter.toUpperCase()]);var e=c.getExtension(a,"EXT_texture_filter_anisotropic");e&&this.anisotropic>1&&a.texParameterf(a.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),this.image?a.texImage2D(a.TEXTURE_2D,0,b,b,d,this.image):a.texImage2D(a.TEXTURE_2D,0,b,this.width,this.height,0,b,d,this.pixels),!this.NPOT&&this.useMipmap&&a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null)},generateMipmap:function(a){a.bindTexture(a.TEXTURE_2D,this.cache.get("webgl_texture")),a.generateMipmap(a.TEXTURE_2D)},isPowerOfTwo:function(){if(this.image)var a=this.image.width,b=this.image.height;else var a=this.width,b=this.height;return 0===(a&a-1)&&0===(b&b-1)},isRenderable:function(){return this.image?"CANVAS"===this.image.nodeName||this.image.complete:this.width&&this.height},bind:function(a){a.bindTexture(a.TEXTURE_2D,this.getWebGLTexture(a))},unbind:function(a){a.bindTexture(a.TEXTURE_2D,null)},load:function(a){var b=new Image,c=this;b.onload=function(){c.dirty(),c.trigger("load"),b.onload=null},b.src=a,this.image=b}});return d}),d("3d/texture/texturecube",["require","../texture","../webglinfo","_"],function(a){function b(a){return"CANVAS"===a.nodeName||a.complete}var c=a("../texture"),d=a("../webglinfo"),e=a("_"),f={px:"TEXTURE_CUBE_MAP_POSITIVE_X",py:"TEXTURE_CUBE_MAP_POSITIVE_Y",pz:"TEXTURE_CUBE_MAP_POSITIVE_Z",nx:"TEXTURE_CUBE_MAP_NEGATIVE_X",ny:"TEXTURE_CUBE_MAP_NEGATIVE_Y",nz:"TEXTURE_CUBE_MAP_NEGATIVE_Z"},g=c.derive({image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null}},{update:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture")),this.beforeUpdate(a);var b=a[this.format.toUpperCase()],c=a[this.type.toUpperCase()];a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a[this.wrapS.toUpperCase()]),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a[this.wrapT.toUpperCase()]),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a[this.magFilter.toUpperCase()]),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a[this.minFilter.toUpperCase()]);var g=d.getExtension(a,"EXT_texture_filter_anisotropic");g&&this.anisotropic>1&&a.texParameterf(a.TEXTURE_CUBE_MAP,g.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),e.each(this.image,function(d,e){d?a.texImage2D(a[f[e]],0,b,b,c,d):a.texImage2D(a[f[e]],0,b,this.width,this.height,0,b,c,this.pixels[e])},this),!this.NPOT&&this.useMipmap&&a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null)},generateMipmap:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture")),a.generateMipmap(a.TEXTURE_CUBE_MAP)},bind:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.getWebGLTexture(a))},unbind:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){function a(a){return a&0===a-1}return this.image.px?a(this.image.px.width)&&a(this.image.px.height):a(this.width)&&a(this.height)},isRenderable:function(){return this.image.px?b(this.image.px)&&b(this.image.nx)&&b(this.image.py)&&b(this.image.ny)&&b(this.image.pz)&&b(this.image.nz):this.width&&this.height},load:function(a){var b=0,c=this;e.each(a,function(a,d){var e=new Image;e.onload=function(){b--,0===b&&(c.dirty(),c.trigger("load")),e.onload=null},b++,e.src=a,c.image[d]=e})}});return g}),d("3d/material",["require","core/base","./shader","util/util","./texture","./texture/texture2d","./texture/texturecube","_"],function(a){var b=a("core/base");a("./shader");var c=a("util/util"),d=a("./texture");a("./texture/texture2d"),a("./texture/texturecube");var e=a("_");_repository=[];var f=b.derive(function(){var a=c.genGUID();return{__GUID__:a,name:"MATERIAL_"+a,uniforms:{},shader:null,depthTest:!0,depthMask:!0,cullFace:!1,transparent:!1,blend:null}},function(){this.shader&&this.attachShader(this.shader),_repository.push(this)},{bind:function(a){var b=0;e.each(this.uniforms,function(c,e){if(!(null===c.value||c.value instanceof Array&&!c.value.length))if(c.value.instanceof&&c.value.instanceof(d)){var f=c.value;if(!f.isRenderable())return;a.activeTexture(a.TEXTURE0+b),f.bind(a),this.shader.setUniform(a,"1i",e,b),b++}else if(c.value instanceof Array){var g=c.value[0];if(g&&g.instanceof&&g.instanceof(d)){for(var h=[],i=0;i<c.value.length;i++){var f=c.value[i];f.isRenderable()&&(a.activeTexture(a.TEXTURE0+b),f.bind(a),h.push(b++))}this.shader.setUniform(a,"1iv",e,h)}else this.shader.setUniform(a,c.type,e,c.value)}else this.shader.setUniform(a,c.type,e,c.value)},this)},set:function(a,b){if("object"==typeof a)for(var c in a){var d=a[c];this.set(c,d)}else{var e=this.uniforms[a];e&&(e.value=b)}},get:function(a){var b=this.uniforms[a];return b?b.value:void 0},attachShader:function(a){this.uniforms=a.createUniforms(),this.shader=a},detachShader:function(){this.shader=null,this.uniforms={}},dispose:function(){_repository.splice(_repository.indexOf(this),1)}});return f.getMaterial=function(a){for(var b=0;b<_repository.length;b++)if(_repository[b].name===a)return _repository[b]},f}),d("3d/mesh",["require","./node","core/vector3","_"],function(a){var b=a("./node");a("core/vector3"),a("_");var c=0,d=b.derive(function(){return{material:null,geometry:null,mode:"TRIANGLES",receiveShadow:!0,castShadow:!0,skeleton:null}},{render:function(a,b){var d=a.gl;this.trigger("beforerender",d);var e=b||this.material,f=e.shader,g=this.geometry,h=d[this.mode.toUpperCase()];if(this.skeleton){var i=this.skeleton.getBoneMatricesArray();f.setUniform(d,"m4v","boneMatrices",i)}for(var j=g.getBufferChunks(d),k=0;k<j.length;k++){currentDrawID=d.__GUID__+"_"+g.__GUID__+"_"+k;var l=j[k],m=l.attributeBuffers,n=l.indicesBuffer;if(currentDrawID!==c){c=currentDrawID,availableAttributes={};for(var o in m){var p=m[o],q=p.semantic;if(q)var r=f.semantics[q],s=r&&r.symbol;else var s=o;s&&f.attributeTemplates[s]&&(availableAttributes[s]=p)}f.enableAttributes(d,Object.keys(availableAttributes));for(var s in availableAttributes){var p=availableAttributes[s],t=p.buffer;d.bindBuffer(d.ARRAY_BUFFER,t),f.setMeshAttribute(d,s,p.type,p.size)}}g.isUseFace()?(d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,n.buffer),d.drawElements(h,n.count,d.UNSIGNED_SHORT,0)):d.drawArrays(h,0,g.getVerticesNumber())}var u={};return this.trigger("afterrender",d,u),u}});return d.materialChanged=function(){c=0},d}),d("3d/compositor/shaders/vertex.essl",[],function(){return"uniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\nvarying vec2 v_Texcoord;\n\nvoid main(){\n\n    v_Texcoord = texcoord;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}"}),d("3d/compositor/shaders/coloradjust.essl",[],function(){return'@export buildin.compositor.coloradjust\n\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float exposure : 0.0;\nuniform float gamma : 1.0;\nuniform float saturation : 1.0;\n\n// Values from "Graphics Shaders: Theory and Practice" by Bailey and Cunningham\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n\n    // brightness\n    vec3 color = clamp(tex.rgb + vec3(brightness), 0.0, 1.0);\n    // contrast\n    color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n    // exposure\n    color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n    // gamma\n    color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n    // saturation\n    float luminance = dot( color, w );\n    color = mix(vec3(luminance), color, saturation);\n    \n    gl_FragColor = vec4(color, tex.a);\n}\n\n@end\n\n// Seperate shader for float texture\n@export buildin.compositor.brightness\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness : 0.0;\n\nvoid main() {\n    vec4 tex = texture2D( texture, v_Texcoord);\n    vec3 color = tex.rgb + vec3(brightness);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.contrast\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float contrast : 1.0;\n\nvoid main() {\n    vec4 tex = texture2D( texture, v_Texcoord);\n    vec3 color = (tex.rgb-vec3(0.5))*contrast+vec3(0.5);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.exposure\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float exposure : 0.0;\n\nvoid main() {\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = tex.rgb * pow(2.0, exposure);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.gamma\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float gamma : 1.0;\n\nvoid main() {\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = pow(tex.rgb, vec3(gamma));\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.saturation\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float saturation : 1.0;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main() {\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = tex.rgb;\n    float luminance = dot(color, w);\n    color = mix(vec3(luminance), color, saturation);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end'}),d("3d/compositor/shaders/blur.essl",[],function(){return"/**\n *  http://www.gamerendering.com/2008/10/11/gaussian-blur-filter-shader/\n */\n\n@export buildin.compositor.gaussian_blur_v\n\nuniform sampler2D texture; // the texture with the scene you want to blur\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0; \nuniform float imageWidth : 512.0;\n\nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x - 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x - blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x + blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.gaussian_blur_h\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0;\nuniform float imageHeight : 512.0;\n \nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 4.0*blurSize/imageHeight)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 4.0*blurSize/imageHeight)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.box_blur\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 3.0;\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n\n   vec4 tex = texture2D(texture, v_Texcoord);\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, -offset.y) );\n\n   tex /= 9.0;\n   return tex;\n}\n\n@end\n\n// http://www.slideshare.net/DICEStudio/five-rendering-ideas-from-battlefield-3-need-for-speed-the-run\n@export buildin.compositor.hexagonal_blur_mrt_1\n\n// MRT in chrome\n// https://www.khronos.org/registry/webgl/sdk/tests/conformance/extensions/ext-draw-buffers.html\n#extension GL_EXT_draw_buffers : require\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragData[0] = color;\n   vec4 color2 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragData[1] = (color + color2) / 2.0;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_mrt_2\n\nuniform sampler2D texture0;\nuniform sampler2D texture1;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture0, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2) / 2.0;\n}\n\n@end\n\n\n@export buildin.compositor.hexagonal_blur_1\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_2\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n@end\n\n@export buildin.compositor.hexagonal_blur_3\n\nuniform sampler2D texture1;\nuniform sampler2D texture2;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture1, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   vec4 color3 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color3 += 1.0/10.0 * texture2D(texture2, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2 + color3) / 3.0;\n}\n\n@end"
}),d("3d/compositor/shaders/grayscale.essl",[],function(){return"\n@export buildin.compositor.grayscale\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord );\n    float luminance = dot(tex.rgb, w);\n\n    gl_FragColor = vec4(vec3(luminance), tex.a);\n}\n\n@end"}),d("3d/compositor/shaders/lut.essl",[],function(){return"\n// https://github.com/BradLarson/GPUImage?source=c\n@export buildin.compositor.lut\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform sampler2D lookup;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    float blueColor = tex.b * 63.0;\n    \n    vec2 quad1;\n    quad1.y = floor(floor(blueColor) / 8.0);\n    quad1.x = floor(blueColor) - (quad1.y * 8.0);\n    \n    vec2 quad2;\n    quad2.y = floor(ceil(blueColor) / 8.0);\n    quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n    \n    vec2 texPos1;\n    texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec2 texPos2;\n    texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec4 newColor1 = texture2D(lookup, texPos1);\n    vec4 newColor2 = texture2D(lookup, texPos2);\n    \n    vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n    gl_FragColor = vec4(newColor.rgb, tex.w);\n}\n\n@end"}),d("3d/compositor/shaders/output.essl",[],function(){return"\n@export buildin.compositor.output\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord );\n\n    gl_FragColor = tex;\n}\n\n@end"}),d("3d/compositor/pass",["require","core/base","../scene","../camera/orthographic","../geometry/plane","../shader","../material","../mesh","../scene","./shaders/vertex.essl","../texture","../webglinfo","./shaders/coloradjust.essl","./shaders/blur.essl","./shaders/grayscale.essl","./shaders/lut.essl","./shaders/output.essl"],function(a){var b=a("core/base"),c=a("../scene"),d=a("../camera/orthographic"),e=a("../geometry/plane"),f=a("../shader"),g=a("../material"),h=a("../mesh"),c=a("../scene"),i=a("./shaders/vertex.essl");a("../texture");var j=a("../webglinfo"),k=new e,l=new h({geometry:k}),m=new c,n=new d;m.add(l);var o=b.derive(function(){return{fragment:"",outputs:null,material:null}},function(){var a=new f({vertex:i,fragment:this.fragment}),b=new g({shader:a});a.enableTexturesAll(),this.material=b},{setUniform:function(a,b){var c=this.material.uniforms[a];c&&(c.value=b)},bind:function(a,b){if(this.outputs){for(var c in this.outputs){var d=this.outputs[c];b.attach(a.gl,d,c)}b.bind(a)}},unbind:function(a,b){b.unbind(a)},render:function(a,b){var c=a.gl;l.material=this.material,b&&this.bind(a,b);var d=j.getExtension(c,"EXT_draw_buffers");if(d){var e=[];for(var f in this.outputs)f=parseInt(f),f>=c.COLOR_ATTACHMENT0&&f<=c.COLOR_ATTACHMENT0+8&&e.push(f);d.drawBuffersEXT(e)}this.trigger("beforerender",a),a.render(m,n,!0),this.trigger("afterrender",a),b&&this.unbind(a,b)}});return f.import(a("./shaders/coloradjust.essl")),f.import(a("./shaders/blur.essl")),f.import(a("./shaders/grayscale.essl")),f.import(a("./shaders/lut.essl")),f.import(a("./shaders/output.essl")),o}),d("3d/framebuffer",["require","core/base","./texture/texture2d","./texture/texturecube","./webglinfo"],function(a){var b=a("core/base");a("./texture/texture2d");var c=a("./texture/texturecube"),d=a("./webglinfo"),e=b.derive(function(){return{depthBuffer:!0,_attachedTextures:{}}},{bind:function(a){var b=a.gl;if(b.bindFramebuffer(b.FRAMEBUFFER,this.getFrameBuffer(b)),this.cache.put("viewport",a.viewportInfo),a.setViewport(0,0,this.cache.get("width"),this.cache.get("height")),this.cache.miss("renderbuffer")&&this.depthBuffer&&!this.cache.get("depth_texture")&&this.cache.put("renderbuffer",b.createRenderbuffer()),!this.cache.get("depth_texture")&&this.depthBuffer){var c=this.cache.get("width"),d=this.cache.get("height"),e=this.cache.get("renderbuffer");(c!==this.cache.get("renderbuffer_width")||d!==this.cache.get("renderbuffer_height"))&&(b.bindRenderbuffer(b.RENDERBUFFER,e),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,c,d),this.cache.put("renderbuffer_width",c),this.cache.put("renderbuffer_height",d),b.bindRenderbuffer(b.RENDERBUFFER,null)),this.cache.get("renderbuffer_attached")||(b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,e),this.cache.put("renderbuffer_attached",!0))}},unbind:function(a){var b=a.gl;b.bindFramebuffer(b.FRAMEBUFFER,null),this.cache.use(b.__GUID__);var d=this.cache.get("viewport");d&&a.setViewport(d.x,d.y,d.width,d.height);for(var e in this._attachedTextures){var f=this._attachedTextures[e];if(!f.NPOT&&f.useMipmap){var g=f.instanceof(c)?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;b.bindTexture(g,f.getWebGLTexture(b)),b.generateMipmap(g),b.bindTexture(g,null)}}},getFrameBuffer:function(a){return this.cache.use(a.__GUID__),this.cache.miss("framebuffer")&&this.cache.put("framebuffer",a.createFramebuffer()),this.cache.get("framebuffer")},attach:function(a,b,c,e){if(!b.width)return console.error("The texture attached to color buffer is not a valid."),void 0;if(a.bindFramebuffer(a.FRAMEBUFFER,this.getFrameBuffer(a)),this.cache.put("width",b.width),this.cache.put("height",b.height),e=e||a.TEXTURE_2D,c=c||a.COLOR_ATTACHMENT0,c===a.DEPTH_ATTACHMENT){var f=d.getExtension(a,"WEBGL_depth_texture");if(!f)return console.error(" Depth texture is not supported by the browser "),void 0;if("DEPTH_COMPONENT"!==b.format)return console.error("The texture attached to depth buffer is not a valid."),void 0;this.cache.put("renderbuffer_attached",!1),this.cache.put("depth_texture",!0)}this._attachedTextures[c]=b,a.framebufferTexture2D(a.FRAMEBUFFER,c,e,b.getWebGLTexture(a),0),a.bindFramebuffer(a.FRAMEBUFFER,null)},detach:function(){},dispose:function(a){this.cache.use(a.__GUID__),this.cache.get("renderbuffer")&&a.deleteRenderbuffer(this.cache.get("renderbuffer")),this.cache.get("framebuffer")&&a.deleteFramebuffer(this.cache.get("framebuffer")),this.cache.clearContext()}});return e}),d("3d/compositor/texturepool",["require","../texture/texture2d","_"],function(a){function b(a){var b={width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",useMipmap:!0,anisotropy:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1};g.defaults(a,b),c(a);var d="";for(var e in b){if(a[e])var f=a[e].toString();else var f=b[e].toString();d+=f}return d}function c(a){var b=d(a.width,a.height);"DEPTH_COMPONENT"===a.format&&(a.useMipmap=!1),b&&a.useMipmap||(a.minFilter=0==a.minFilter.indexOf("NEAREST")?"NEAREST":"LINEAR",a.magFilter=0==a.magFilter.indexOf("NEAREST")?"NEAREST":"LINEAR",a.wrapS="CLAMP_TO_EDGE",a.wrapT="CLAMP_TO_EDGE")}function d(a,b){return 0===(a&a-1)&&0===(b&b-1)}var e=a("../texture/texture2d"),g=a("_"),h={},i={get:function(a){var c=b(a);h.hasOwnProperty(c)||(h[c]=[]);var d=h[c];if(!d.length){var f=new e(a);return f}return d.pop()},put:function(a){var c=b(a);h.hasOwnProperty(c)||(h[c]=[]);var d=h[c];d.push(a)},clear:function(a){for(f in h)for(var b=0;b<h[f].length;b++)h[f][b].dispose(a);h={}}};return i}),d("3d/compositor/node",["require","core/base","./pass","../framebuffer","../shader","./texturepool"],function(a){var b=a("core/base"),c=a("./pass"),d=a("../framebuffer");a("../shader");var e=a("./texturepool"),f=b.derive(function(){return{name:"",inputs:{},outputs:null,shader:"",inputLinks:{},outputLinks:{},pass:null,_outputTextures:{},_outputReferences:{},_rendering:!1}},function(){if(this.shader){var a=new c({fragment:this.shader});this.pass=a}this.outputs&&(this.frameBuffer=new d({depthBuffer:!1}))},{render:function(a){this._rendering=!0;var b=a.gl;for(var c in this.inputLinks){var d=this.inputLinks[c],f=d.node.getOutput(a,d.pin);this.pass.setUniform(c,f)}if(this.outputs){this.pass.outputs={};for(var g in this.outputs){var h=this.outputs[g],i=e.get(h.parameters||{});this._outputTextures[g]=i;var j=h.attachment||b.COLOR_ATTACHMENT0;"string"==typeof j&&(j=b[j]),this.pass.outputs[j]=i}this.pass.render(a,this.frameBuffer)}else this.pass.outputs=null,this.pass.render(a);for(var c in this.inputLinks){var d=this.inputLinks[c];d.node.removeReference(d.pin)}this._rendering=!1},setParameter:function(a,b){this.pass.setUniform(a,b)},setParameters:function(a){for(var b in a)this.setParameter(b,a[b])},getOutput:function(a,b){var c=this.outputs[b];if(c){if(this._outputTextures[b])return this._outputTextures[b];if(this._rendering){var d=e.get(c.parameters||{});return this._outputTextures[b]=d,d}return this.render(a),this._outputTextures[b]}},removeReference:function(a){this._outputReferences[a]--,0===this._outputReferences[a]&&(e.put(this._outputTextures[a]),this._outputTextures[a]=null)},link:function(a,b,c){this.inputLinks[a]={node:b,pin:c},b.outputLinks[c]||(b.outputLinks[c]=[]),b.outputLinks[c].push({node:this,pin:a})},clear:function(){this.inputLinks={},this.outputLinks={}},updateReference:function(){for(var a in this.outputLinks)this._outputReferences[a]=this.outputLinks[a].length}});return f}),d("3d/compositor/group",["require","./node","./graph"],function(a){var b=a("./node"),c=a("./graph"),d=b.derive(function(){return{nodes:[],_outputTextures:{}}},{add:function(a){return c.prototype.add.call(this,a)},remove:function(a){return c.prototype.remove.call(this,a)},update:function(){return c.prototype.update.call(this)},findPin:function(a){return c.prototype.findPin.call(this,a)},render:function(a){this._dirty&&(this.update(),this._dirty=!1);var b={};for(var c in this.inputLinks){var d=this.inputLinks[c],e=d.node.getOutput(a,d.pin);b[c]=e}for(var f=0;f<this.nodes.length;f++){var g=this.nodes[f];g.updateReference(),g.groupInputs&&this._updateGroupInputs(g,b)}for(var f=0;f<this.nodes.length;f++){var g=this.nodes[f];g.groupOutputs&&this._updateGroupOutputs(g,a),g.outputs||g.render(a)}for(var h in this.groupOutputs)this._outputTextures[h]||console.error('Group output pin "'+h+'" is not attached');for(var c in this.inputLinks){var d=this.inputLinks[c];d.node.removeReference(d.pin)}},_updateGroupInputs:function(a,b){for(var c in b){var d=b[c];if(a.groupInputs[c]){var e=a.groupInputs[c];a.pass.setUniform(e,d)}}},_updateGroupOutputs:function(a,b){for(var c in a.groupOutputs){var d=a.groupOutputs[c],e=a.getOutput(b,c);this._outputTextures[d]=e}}});return d}),d("3d/compositor/scenenode",["require","./node","./pass","../framebuffer","./texturepool","../webglinfo"],function(a){var b=a("./node");a("./pass"),a("../framebuffer");var c=a("./texturepool"),d=a("../webglinfo"),e=b.derive(function(){return{scene:null,camera:null,material:null}},function(){this.frameBuffer&&(this.frameBuffer.depthBuffer=!0)},{render:function(a){this._rendering=!0;var b=a.gl;if(this.outputs){var e=this.frameBuffer;for(var f in this.outputs){var g=this.outputs[f],h=c.get(g.parameters||{});this._outputTextures[f]=h;var i=g.attachment||b.COLOR_ATTACHMENT0;"string"==typeof i&&(i=b[i]),e.attach(a.gl,h,i)}e.bind(a);var j=d.getExtension(b,"EXT_draw_buffers");if(j){var k=[];for(var i in this.outputs)i=parseInt(i),i>=b.COLOR_ATTACHMENT0&&i<=b.COLOR_ATTACHMENT0+8&&k.push(i);j.drawBuffersEXT(k)}this.material&&(this.scene.material=this.material),a.render(this.scene,this.camera),this.scene.material=null,e.unbind(a)}else a.render(this.scene,this.camera);this._rendering=!1}});return e}),d("3d/compositor/texturenode",["require","./node","../framebuffer","./texturepool","../shader"],function(a){var b=a("./node");a("../framebuffer");var c=a("./texturepool"),d=a("../shader"),e=b.derive(function(){return{shader:d.source("buildin.compositor.output"),texture:null}},{render:function(a){this._rendering=!0;var b=a.gl;if(this.pass.setUniform("texture",this.texture),this.outputs){this.pass.outputs={};for(var d in this.outputs){var e=this.outputs[d],f=c.get(e.parameters||{});this._outputTextures[d]=f;var g=e.attachment||b.COLOR_ATTACHMENT0;"string"==typeof g&&(g=b[g]),this.pass.outputs[g]=f}this.pass.render(a,this.frameBuffer)}else this.pass.outputs=null,this.pass.render(a);this._rendering=!1}});return e}),d("3d/light",["require","./node"],function(a){var b=a("./node"),c=b.derive(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512}},{});return c}),d("3d/renderer",["require","core/base","_","glmatrix","util/util","./light","./mesh","./webglinfo"],function(a){var b=a("core/base"),c=a("_"),d=a("glmatrix"),e=d.mat4,f=a("util/util"),g=a("./light"),h=a("./mesh"),i=a("./webglinfo"),j=b.derive(function(){return{__GUID__:f.genGUID(),canvas:null,devicePixelRatio:window.devicePixelRatio||1,color:[0,0,0,0],clear:17664,alhpa:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,gl:null,viewportInfo:{}}},function(){this.canvas||(this.canvas=document.createElement("canvas"));try{this.gl=this.canvas.getContext("experimental-webgl",{alhpa:this.alhpa,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer}),this.gl.__GUID__=this.__GUID__,this.resize(this.canvas.width,this.canvas.height),i.initialize(this.gl)}catch(a){throw"Error creating WebGL Context"}},{resize:function(a,b){var c=this.canvas;1!==this.devicePixelRatio&&(c.style.width=a+"px",c.style.height=b+"px"),c.width=a*this.devicePixelRatio,c.height=b*this.devicePixelRatio,this.setViewport(0,0,c.width,c.height)},setViewport:function(a,b,c,d){this.gl.viewport(a,b,c,d),this.viewportInfo={x:a,y:b,width:c,height:d}},render:function(a,b,d){var e=this.gl;d||this.trigger("beforerender",a,b);var f=this.color;e.clearColor(f[0],f[1],f[2],f[3]),e.clear(this.clear);var h=[],i=[],j=[];b.update(),a.update(),this._scene=a;var k=a.material;a.traverse(function(a){if(!a.visible)return!0;if(a.instanceof(g)&&j.push(a),a.render)if(k)k.transparent?i.push(a):h.push(a);else{if(!a.material||!a.material.shader)return;if(!a.geometry)return;a.material.transparent?i.push(a):h.push(a)}}),a.filter&&(h=c.filter(h,a.filter),i=c.filter(i,a.filter));for(var l={},m=0;m<j.length;m++){var n=j[m];l[n.type]||(l[n.type]=0),l[n.type]++}a.lightNumber=l,this.updateLightUnforms(j),h.sort(this._materialSortFunc),i.sort(this._materialSortFunc),d||this.trigger("beforerender:opaque",h),e.disable(e.BLEND),this.renderQueue(h,b,k,d),d||(this.trigger("afterrender:opaque",h),this.trigger("beforerender:transparent",i)),e.enable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),this.renderQueue(i,b,k,d),d||(this.trigger("afterrender:transparent",i),this.trigger("afterrender",a,b))},updateLightUnforms:function(a){var b=this._scene.lightUniforms;for(var c in b)b[c].value.length=0;for(var d=0;d<a.length;d++){var e=a[d];for(c in e.uniformTemplates){var f=e.uniformTemplates[c];b[c]||(b[c]={type:"",value:[]});var g=f.value(e),h=b[c];switch(h.type=f.type+"v",f.type){case"1i":case"1f":h.value.push(g);break;case"2f":case"3f":case"4f":for(var i=0;i<g.length;i++)h.value.push(g[i]);break;default:console.error("Unkown light uniform type "+f.type)}}}},renderQueue:function(a,b,d,f){e.invert(k.VIEW,b.worldMatrix._array),e.copy(k.PROJECTION,b.projectionMatrix._array),e.multiply(k.VIEWPROJECTION,b.projectionMatrix._array,k.VIEW),e.copy(k.VIEWINVERSE,b.worldMatrix._array),e.invert(k.PROJECTIONINVERSE,k.PROJECTION),e.invert(k.VIEWPROJECTIONINVERSE,k.VIEWPROJECTION);for(var g,i,j,l,m=this.gl,n=this._scene,o=0;o<a.length;o++){var p=a[o],q=d||p.material,r=q.shader;p.geometry;var s=q.transparent&&q.blend;if(i!==r.__GUID__){var t=!1;if(c.isEqual(r.lightNumber,n.lightNumber)||(t=!0),t){for(var u in n.lightNumber){var v=n.lightNumber[u];r.lightNumber[u]=v}r.dirty()}r.bind(m);for(var w in n.lightUniforms){var x=n.lightUniforms[w];r.setUniform(m,x.type,w,x.value)}i=r.__GUID__}g!==q.__GUID__&&(q.depthTest!==j&&(q.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),j=q.depthTest),q.depthMask!==l&&(m.depthMask(q.depthMask),l=q.depthMask),q.bind(m),g=q.__GUID__,h.materialChanged()),s&&s(m);var y=p.worldMatrix._array;(r.semantics.hasOwnProperty("WORLD")||r.semantics.hasOwnProperty("WORLDTRANSPOSE"))&&e.copy(k.WORLD,y),(r.semantics.hasOwnProperty("WORLDVIEW")||r.semantics.hasOwnProperty("WORLDVIEWINVERSE")||r.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE"))&&e.multiply(k.WORLDVIEW,k.VIEW,y),(r.semantics.hasOwnProperty("WORLDVIEWPROJECTION")||r.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||r.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE"))&&e.multiply(k.WORLDVIEWPROJECTION,k.VIEWPROJECTION,y),(r.semantics.hasOwnProperty("WORLDINVERSE")||r.semantics.hasOwnProperty("WORLDINVERSETRANSPOSE"))&&e.invert(k.WORLDINVERSE,y),(r.semantics.hasOwnProperty("WORLDVIEWINVERSE")||r.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE"))&&e.invert(k.WORLDVIEWINVERSE,k.WORLDVIEW),(r.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||r.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE"))&&e.invert(k.WORLDVIEWPROJECTIONINVERSE,k.WORLDVIEWPROJECTION);for(var z in k){if(r.semantics.hasOwnProperty(z)){var A=k[z],B=r.semantics[z];r.setUniform(m,B.type,B.symbol,A)}if(r.semantics.hasOwnProperty(z+"TRANSPOSE")){var C=k[z+"TRANSPOSE"],A=k[z],D=r.semantics[z+"TRANSPOSE"];e.transpose(C,A),r.setUniform(m,D.type,D.symbol,C)}}f||this.trigger("beforerender:mesh",p);var E=p.render(this,d);f||this.trigger("afterrender:mesh",p,E),s&&(m.blendEquationSeparate(m.FUNC_ADD,m.FUNC_ADD),m.blendFuncSeparate(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA,m.ONE,m.ONE_MINUS_SRC_ALPHA))}},_materialSortFunc:function(a,b){return a.material.shader==b.material.shader?a.material.__GUID__-b.material.__GUID__:a.material.shader.__GUID__-b.material.__GUID__}}),k={WORLD:e.create(),VIEW:e.create(),PROJECTION:e.create(),WORLDVIEW:e.create(),VIEWPROJECTION:e.create(),WORLDVIEWPROJECTION:e.create(),WORLDINVERSE:e.create(),VIEWINVERSE:e.create(),PROJECTIONINVERSE:e.create(),WORLDVIEWINVERSE:e.create(),VIEWPROJECTIONINVERSE:e.create(),WORLDVIEWPROJECTIONINVERSE:e.create(),WORLDTRANSPOSE:e.create(),VIEWTRANSPOSE:e.create(),PROJECTIONTRANSPOSE:e.create(),WORLDVIEWTRANSPOSE:e.create(),VIEWPROJECTIONTRANSPOSE:e.create(),WORLDVIEWPROJECTIONTRANSPOSE:e.create(),WORLDINVERSETRANSPOSE:e.create(),VIEWINVERSETRANSPOSE:e.create(),PROJECTIONINVERSETRANSPOSE:e.create(),WORLDVIEWINVERSETRANSPOSE:e.create(),VIEWPROJECTIONINVERSETRANSPOSE:e.create(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:e.create()};return j}),d("3d/util/mesh",["require","../geometry","../mesh","glmatrix","_"],function(a){var b=a("../geometry"),c=a("../mesh"),d=a("glmatrix"),e=a("_");d.mat4;var f=d.vec3,g={merge:function(a,d){function g(a){return d?a&&Array.prototype.slice.call(a):a}if(a.length){var d="undefined"==typeof d?!0:d,h=a[0],i=h.geometry,j=h.material;e.any(a,function(a){return a.material!==j})&&console.warn("Material of meshes to merge is not the same, program will use the material of first mesh by default");var k=new b,l=k.faces;for(var m in i.attributes){var n=i.attributes[m];k.attributes[m]||(k.attributes[m]={value:[],type:n.type})}for(var o=0,p=0!==i.faces.length,q=0;q<a.length;q++){var r=a[q],s=r.geometry;r.updateMatrix();var t=s.getVerticesNumber();for(var m in s.attributes){var u=s.attributes[m],v=k.attributes[m];if(u.value.length)for(var w=0;t>w;w++)if("position"===m){var x=g(u.value[w]);f.transformMat4(x,x,r.matrix._array),v.value.push(x)}else if("normal"===m){var x=g(u.value[w]);v.value.push(x)}else if("tangent"===m){var x=g(u.value[w]);v.value.push(x)}else v.value.push(g(u.value[w]))}if(p){var y=s.faces.length;for(w=0;y>w;w++){var z=[],A=s.faces[w];z[0]=A[0]+o,z[1]=A[1]+o,z[2]=A[2]+o,l.push(z)}}o+=t}return new c({material:j,geometry:k})}}};return g}),d("animation/easing",[],function(){var a={Linear:function(a){return a},QuadraticIn:function(a){return a*a},QuadraticOut:function(a){return a*(2-a)},QuadraticInOut:function(a){return(a*=2)<1?.5*a*a:-.5*(--a*(a-2)-1)},CubicIn:function(a){return a*a*a},CubicOut:function(a){return--a*a*a+1},CubicInOut:function(a){return(a*=2)<1?.5*a*a*a:.5*((a-=2)*a*a+2)},QuarticIn:function(a){return a*a*a*a},QuarticOut:function(a){return 1- --a*a*a*a},QuarticInOut:function(a){return(a*=2)<1?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)},QuinticIn:function(a){return a*a*a*a*a},QuinticOut:function(a){return--a*a*a*a*a+1},QuinticInOut:function(a){return(a*=2)<1?.5*a*a*a*a*a:.5*((a-=2)*a*a*a*a+2)},SinusoidalIn:function(a){return 1-Math.cos(a*Math.PI/2)},SinusoidalOut:function(a){return Math.sin(a*Math.PI/2)},SinusoidalInOut:function(a){return.5*(1-Math.cos(Math.PI*a))},ExponentialIn:function(a){return 0===a?0:Math.pow(1024,a-1)},ExponentialOut:function(a){return 1===a?1:1-Math.pow(2,-10*a)},ExponentialInOut:function(a){return 0===a?0:1===a?1:(a*=2)<1?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)},CircularIn:function(a){return 1-Math.sqrt(1-a*a)},CircularOut:function(a){return Math.sqrt(1- --a*a)},CircularInOut:function(a){return(a*=2)<1?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)},ElasticIn:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),-(c*Math.pow(2,10*(a-=1))*Math.sin((a-b)*2*Math.PI/d)))},ElasticOut:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),c*Math.pow(2,-10*a)*Math.sin((a-b)*2*Math.PI/d)+1)},ElasticInOut:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),(a*=2)<1?-.5*c*Math.pow(2,10*(a-=1))*Math.sin((a-b)*2*Math.PI/d):.5*c*Math.pow(2,-10*(a-=1))*Math.sin((a-b)*2*Math.PI/d)+1)},BackIn:function(a){var b=1.70158;return a*a*((b+1)*a-b)},BackOut:function(a){var b=1.70158;return--a*a*((b+1)*a+b)+1},BackInOut:function(a){var b=2.5949095;return(a*=2)<1?.5*a*a*((b+1)*a-b):.5*((a-=2)*a*((b+1)*a+b)+2)},BounceIn:function(b){return 1-a.BounceOut(1-b)},BounceOut:function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375},BounceInOut:function(b){return.5>b?.5*a.BounceIn(2*b):.5*a.BounceOut(2*b-1)+.5}};return a}),d("animation/clip",["require","./easing"],function(a){var b=a("./easing"),c=function(a){this._targetPool=a.target||{},this._targetPool.constructor!=Array&&(this._targetPool=[this._targetPool]),this._life=a.life||1e3,this._delay=a.delay||0,this._startTime=(new Date).getTime()+this._delay,this._endTime=this._startTime+1e3*this._life,this.loop="undefined"==typeof a.loop?!1:a.loop,this.loop&&(this._currentLoop="number"==typeof this.loop?this.loop:9999999),this.gap=a.gap||0,this.easing=a.easing||"Linear",this.onframe=a.onframe||null,this.ondestroy=a.ondestroy||null,this.onrestart=a.onrestart||null};return c.prototype={step:function(a){var c=(a-this._startTime)/this._life;if(!(0>c)){c=Math.min(c,1);var d,e="string"==typeof this.easing?b[this.easing]:this.easing;return d="function"==typeof e?e(c):c,this.fire("frame",d),1==c?this.loop&&this._currentLoop?(this.restart(),this._currentLoop--,"restart"):(this._needsRemove=!0,"destroy"):null}},restart:function(){this._startTime=(new Date).getTime()+this.gap},fire:function(a,b){for(var c=0,d=this._targetPool.length;d>c;c++)this["on"+a]&&this["on"+a](this._targetPool[c],b)}},c.prototype.constructor=c,c}),d("animation/animation",["require","./clip","_"],function(a){function b(a,b){return a[b]}function c(a,b,c){a[b]=c}function d(a,b,c){return(b-a)*c+a}function e(a,e,f,g,h){this._tracks={},this._target=a,this._loop=e||!1,this._getter=f||b,this._setter=g||c,this._interpolate=h||d,this._clipCount=0,this._delay=0,this._doneList=[],this._onframeList=[],this._clipList=[]}var f=a("./clip");a("_");var g=window.requrestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,16)},h=function(a){a=a||{},this.stage=a.stage||{},this.onframe=a.onframe||function(){},this._clips=[],this._running=!1};return h.prototype={add:function(a){this._clips.push(a)},remove:function(a){var b=this._clips.indexOf(a);b>=0&&this._clips.splice(b,1)},update:function(){for(var a=(new Date).getTime(),b=this._clips,c=b.length,d=[],e=[],f=0;c>f;f++){var g=b[f],h=g.step(a);h&&(d.push(h),e.push(g))}this.stage&&this.stage.render&&this._clips.length&&this.stage.render();for(var i=[],f=0;c>f;f++)b[f]._needsRemove||(i.push(b[f]),b[f]._needsRemove=!1);this._clips=i,c=d.length;for(var f=0;c>f;f++)e[f].fire(d[f]);this.onframe()},start:function(){function a(){b._running&&(b.update(),g(a))}var b=this;this._running=!0,g(a)},stop:function(){this._running=!1},clear:function(){this._clips=[]},animate:function(a){var b=new e(a.target,a.loop,a.getter,a.setter,a.interpolate);return b.animation=this,b}},h.prototype.constructor=h,e.prototype={when:function(a,b,c){for(var d in b)this._tracks[d]||(this._tracks[d]=[],this._tracks[d].push({time:0,value:this._getter(this._target,d)})),this._tracks[d].push({time:a,value:b[d],easing:c});return this},during:function(a){return this._onframeList.push(a),this},start:function(){function a(a,b,c){var d=a.value,e=b.value;return function(a,b){g=h._interpolate(d,e,b),i(a,c,g);for(var f=0;f<h._onframeList.length;f++)h._onframeList[f](a,b)}}function b(){if(h._clipCount--,0===h._clipCount)for(var a=h._doneList.length,b=0;a>b;b++)h._doneList[b].call(h)}var c,d,e,g,h=this,i=this._setter;for(var j in this._tracks)if(c=this._delay,d=this._tracks[j],d.length){e=d[d.length-1].time;for(var k=0;k<d.length-1;k++){var l=d[k],m=d[k+1],n=new f({target:h._target,life:m.time-l.time,delay:c,loop:h._loop,gap:e-(m.time-l.time),easing:m.easing,onframe:a(l,m,j),ondestroy:b});this._clipList.push(n),this._clipCount++,c=m.time+this._delay,h.animation.add(n)}}return this},stop:function(){for(var a=0;a<this._clipList.length;a++){var b=this._clipList[a];this.animation.remove(b)}},delay:function(a){return this._delay=a,this},done:function(a){return this._doneList.push(a),this}},h}),d("core/matrix2",["require","glmatrix"],function(a){function b(a){return{configurable:!1,set:function(b){this._array[a]=b,this._dirty=!0},get:function(){return this._array[a]}}}var c=a("glmatrix"),d=c.mat2,e=function(){return Object.create(f,{m00:b(0),m01:b(1),m10:b(2),m11:b(3),_array:{writable:!1,configurable:!1,value:d.create()}})},f={constructor:e,clone:function(){return(new e).copy(this)},copy:function(a){return d.copy(this._array,a._array),this},adjoint:function(){return d.adjoint(this._array,this._array),this},determinant:function(){return d.determinant(this._array)},identity:function(){return d.identity(this._array),this},invert:function(){return d.invert(this._array,this._array),this},mul:function(a){return d.mul(this._array,this._array,a._array),this},mulLeft:function(a){return d.mul(this._array,a._array,this._array),this},multiply:function(a){return d.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return d.multiply(this._array,a._array,this._array),this},rotate:function(a){return d.rotate(this._array,this._array,a),this},scale:function(a){d.scale(this._array,this._array,a)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return e}),d("core/request",["require"],function(){function a(a){var b=new XMLHttpRequest;b.open("get",a.url),b.responseType=a.responseType||"text",a.onprogress&&(b.onprogress=function(b){if(b.lengthComputable){var c=b.loaded/b.total;a.onprogress(c,b.loaded,b.total)}else a.onprogress(null)}),b.onload=function(){a.onload&&a.onload(b.response)},a.onerror&&(b.onerror=a.onerror),b.send(null)}function b(){}return{get:a,put:b}}),d("core/vector4",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec4,d=function(a,b,d,f){return a=a||0,b=b||0,d=d||0,f=f||0,Object.create(e,{x:{configurable:!1,set:function(a){this._array[0]=a,this._dirty=!0},get:function(){return this._array[0]}},y:{configurable:!1,set:function(a){this._array[1]=a,this._dirty=!0},get:function(){return this._array[1]}},z:{configurable:!1,set:function(a){this._array[2]=a,this._dirty=!0},get:function(){return this._array[2]}},w:{configurable:!1,set:function(a){this._array[2]=a,this._dirty=!0},get:function(){return this._array[2]}},_array:{writable:!1,configurable:!1,value:c.fromValues(a,b,d,f)},_dirty:{configurable:!1,value:!1}})},e={constructor:d,add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b,c,d){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._array[3]=d,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z,this.w)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return vec2.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return vec2.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},transformQuat:function(a){return c.transformQuat(this._array,this._array,a._array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}};return d}),d("engine",[],function(){var a=window.requrestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,16)},b=function(){};return b.prototype.run=function(){a(function(){})},b}),d("util/color",["require"],function(){}),d("qtek",["require","2d/gradient","2d/layer","2d/lineargradient","2d/node","2d/pattern","2d/picking/box","2d/picking/pixel","2d/shape/path","2d/stage","2d/style","2d/util","3d/bone","3d/boundingbox","3d/camera","3d/camera/perspective","3d/compositor","3d/compositor/graph","3d/compositor/group","3d/compositor/node","3d/compositor/pass","3d/compositor/scenenode","3d/compositor/texturenode","3d/compositor/texturepool","3d/framebuffer","3d/geometry","3d/geometry/plane","3d/light","3d/material","3d/mesh","3d/node","3d/renderer","3d/scene","3d/shader","3d/texture","3d/texture/texture2d","3d/util/mesh","3d/webglinfo","animation/animation","animation/clip","animation/easing","core/base","core/cache","core/event","core/matrix2","core/matrix2d","core/matrix3","core/matrix4","core/mixin/derive","core/mixin/notifier","core/quaternion","core/request","core/vector2","core/vector3","core/vector4","engine","util/color","util/util","glmatrix"],function(a){var b={"2d":{Gradient:a("2d/gradient"),Layer:a("2d/layer"),LinearGradient:a("2d/lineargradient"),Node:a("2d/node"),Pattern:a("2d/pattern"),picking:{Box:a("2d/picking/box"),Pixel:a("2d/picking/pixel")},shape:{Path:a("2d/shape/path")},Stage:a("2d/stage"),Style:a("2d/style"),util:a("2d/util")},"3d":{Bone:a("3d/bone"),BoundingBox:a("3d/boundingbox"),Camera:a("3d/camera"),camera:{Perspective:a("3d/camera/perspective")},Compositor:a("3d/compositor"),compositor:{Graph:a("3d/compositor/graph"),Group:a("3d/compositor/group"),Node:a("3d/compositor/node"),Pass:a("3d/compositor/pass"),SceneNode:a("3d/compositor/scenenode"),TextureNode:a("3d/compositor/texturenode"),TexturePool:a("3d/compositor/texturepool")},FrameBuffer:a("3d/framebuffer"),Geometry:a("3d/geometry"),geometry:{Plane:a("3d/geometry/plane")},Light:a("3d/light"),Material:a("3d/material"),Mesh:a("3d/mesh"),Node:a("3d/node"),Renderer:a("3d/renderer"),Scene:a("3d/scene"),Shader:a("3d/shader"),shader:{},Texture:a("3d/texture"),texture:{Texture2D:a("3d/texture/texture2d")},util:{mesh:a("3d/util/mesh")},WebGLInfo:a("3d/webglinfo")},animation:{Animation:a("animation/animation"),Clip:a("animation/clip"),Easing:a("animation/easing")},core:{Base:a("core/base"),Cache:a("core/cache"),Event:a("core/event"),Matrix2:a("core/matrix2"),Matrix2d:a("core/matrix2d"),Matrix3:a("core/matrix3"),Matrix4:a("core/matrix4"),mixin:{derive:a("core/mixin/derive"),notifier:a("core/mixin/notifier")},Quaternion:a("core/quaternion"),requester:a("core/request"),Vector2:a("core/vector2"),Vector3:a("core/vector3"),Vector4:a("core/vector4")},Engine:a("engine"),util:{Color:a("util/color"),Util:a("util/util")}},c=a("glmatrix");
return b.math=c,b});var e=c("qtek");for(var f in e)a[f]=e[f]}),d("src/fx",["require","qtek"],function(a){var b=a("qtek"),c=b["3d"],d=function(){this.node=null,this.input=null,this.parameters={},this.imageSize={width:512,height:512},Object.defineProperty(this,"input",{set:function(a){this.node&&(this.node.inputs.texture.node=a)},get:function(){return this.node.inputs.texture.node}})};d.prototype.reset=function(){},d.prototype.dispose=function(){},d.prototype.setImageSize=function(a,b){if(this.node)if(this.node.instanceof(c.compositor.Group))for(var d=0;d<this.node.nodes.length;d++){var e=this.node.nodes[d];if(e.setParameters({imageWidth:a,imageHeight:b}),e.outputs)for(var f in e.outputs){var g=e.outputs[f];g.parameters?g.parameters.width||(g.parameters.width=a,g.parameters.height=b):g.parameters={width:a,height:b}}}else{this.node.setParameters({imageWidth:a,imageHeight:b});var e=this.node;if(e.outputs)for(var f in e.outputs){var g=e.outputs[f];g.parameters?g.parameters.width||(g.parameters.width=a,g.parameters.height=b):g.parameters={width:a,height:b}}}};var e={};return d.export=function(a,b){e[a]=b},d.create=function(a){if(!e[a])return console.error("FX "+a+" not exist"),void 0;var b=new e[a];return b},d}),d("src/buildin/gaussian",["require","qtek","../fx"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this),this.node=new c.compositor.Group({inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});var a={width:this.imageSize.width,height:this.imageSize.height,wrapS:"REPEAT",wrapT:"REPEAT"},b=new c.compositor.Node({name:"gaussian_h",shader:c.Shader.source("buildin.compositor.gaussian_blur_h"),groupInputs:{texture:"texture"},outputs:{color:{parameters:a}}}),e=new c.compositor.Node({name:"gaussian_v",shader:c.Shader.source("buildin.compositor.gaussian_blur_v"),inputs:{texture:{node:b,pin:"color"}},outputs:{color:{parameters:a}},groupOutputs:{color:"color"}});this.node.add(b),this.node.add(e);var f=2;this.parameters={blurSize:{max:10,min:0,step:.1,ui:"slider",get value(){return f},set value(a){f=a,e.setParameter("blurSize",a),b.setParameter("blurSize",a)}}},this.reset()};return e.prototype=new d,e.prototype.reset=function(){this.parameters.blurSize.value=2},e.prototype.constructor=e,d.export("buildin.gaussian",e),e}),d("shaders/hexagonal_blur.essl",[],function(){return"@export emage.hexagonal_blur_1\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 30; i++){\n      color += 1.0/30.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n\n@end\n\n@export emage.hexagonal_blur_2\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 30; i++){\n      color += 1.0/30.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n@end\n\n@export emage.hexagonal_blur_3\n\nuniform sampler2D texture1;\nuniform sampler2D texture2;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform float imageWidth : 1.0;\nuniform float imageHeight : 1.0;\n\nvoid main(void){\n   vec2 offset = vec2(blurSize/imageWidth, blurSize/imageHeight);\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 30; i++){\n      color1 += 1.0/30.0 * texture2D(texture1, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 30; i++){\n      color2 += 1.0/30.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   vec4 color3 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 30; i++){\n      color3 += 1.0/30.0 * texture2D(texture2, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2 + color3) / 3.0;\n}\n\n@end"}),d("shaders/gamma.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform float gamma : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    gl_FragColor = vec4(pow(tex.rgb, vec3(gamma)), tex.a);\n}"}),d("src/buildin/lensblur",["require","qtek","../fx","shaders/hexagonal_blur.essl","shaders/gamma.essl","shaders/gamma.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx");c.Shader.import(a("shaders/hexagonal_blur.essl"));var e=function(){d.call(this),this.node=new c.compositor.Group({inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});var b={width:1024,height:1024,type:"FLOAT"},e=new c.compositor.Node({shader:a("shaders/gamma.essl"),groupInputs:{texture:"texture"},outputs:{color:{parameters:b}}}),f=new c.compositor.Node({shader:c.Shader.source("emage.hexagonal_blur_1"),inputs:{texture:{node:e,pin:"color"}},outputs:{color:{parameters:b}}}),g=new c.compositor.Node({shader:c.Shader.source("emage.hexagonal_blur_2"),inputs:{texture:{node:e,pin:"color"}},outputs:{color:{parameters:b}}}),h=new c.compositor.Node({shader:c.Shader.source("emage.hexagonal_blur_3"),inputs:{texture1:{node:f,pin:"color"},texture2:{node:g,pin:"color"}},outputs:{color:{parameters:b}}}),i=new c.compositor.Node({shader:a("shaders/gamma.essl"),inputs:{texture:{node:h,pin:"color"}},outputs:{color:{parameters:{width:1024,height:1024}}},groupOutputs:{color:"color"}});this.node.add(e),this.node.add(f),this.node.add(g),this.node.add(h),this.node.add(i);var j=1,k=6;this.parameters={blurSize:{max:10,min:0,step:.1,ui:"slider",get value(){return j},set value(a){j=a,f.setParameter("blurSize",a),g.setParameter("blurSize",a),h.setParameter("blurSize",a)}},brightness:{max:10,min:0,step:.1,ui:"slider",get value(){return k},set value(a){k=a,e.setParameter("gamma",a),i.setParameter("gamma",1/a)}}},this.reset()};return e.prototype=new d,e.prototype.reset=function(){this.parameters.blurSize.value=.4,this.parameters.brightness.value=6},e.prototype.constructor=e,d.export("buildin.lensblur",e),e}),d("shaders/box_blur.essl",[],function(){return"\n@export emage.box_blur_v\n\nuniform sampler2D texture; // the texture with the scene you want to blur\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0; \nuniform float imageWidth : 512.0;\n\nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   for(int i = 0; i < 40; i++){\n      sum += texture2D(texture, v_Texcoord + vec2(0.0, float(i-20) * blurSize / imageWidth));\n   }\n   gl_FragColor = sum / 40.0;\n}\n\n@end\n\n@export emage.box_blur_h\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0;\nuniform float imageHeight : 512.0;\n \nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   for(int i = 0; i < 40; i++){\n      sum += texture2D(texture, v_Texcoord + vec2(float(i-20) * blurSize / imageHeight, 0.0));\n   }\n   gl_FragColor = sum / 40.0;\n}\n\n@end"}),d("src/buildin/boxblur",["require","qtek","../fx","shaders/box_blur.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx");c.Shader.import(a("shaders/box_blur.essl"));var e=function(){d.call(this),this.node=new c.compositor.Group({inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});var a={width:this.imageSize.width,height:this.imageSize.height,wrapS:"REPEAT",wrapT:"REPEAT"},b=new c.compositor.Node({name:"boxblur_h",shader:c.Shader.source("emage.box_blur_h"),groupInputs:{texture:"texture"},outputs:{color:{parameters:a}}}),e=new c.compositor.Node({name:"boxblur_v",shader:c.Shader.source("emage.box_blur_v"),inputs:{texture:{node:b,pin:"color"}},outputs:{color:{parameters:a}},groupOutputs:{color:"color"}});this.node.add(b),this.node.add(e);var f=2;this.parameters={blurSize:{max:10,min:0,step:.1,ui:"slider",get value(){return f},set value(a){f=a,e.setParameter("blurSize",a),b.setParameter("blurSize",a)}}},this.reset()};return e.prototype=new d,e.prototype.reset=function(){this.parameters.blurSize.value=2},e.prototype.constructor=e,d.export("buildin.boxblur",e),e}),d("src/buildin/coloradjust",["require","qtek","../fx"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var a=new c.compositor.Node({shader:c.Shader.source("buildin.compositor.coloradjust"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=a;var b=0,e=1,f=0,g=1,h=1;this.parameters={brightness:{max:1,min:-1,step:.1,ui:"slider",get value(){return b},set value(c){b=c,a.setParameter("brightness",c)}},contrast:{max:4,min:0,step:.1,ui:"slider",get value(){return e},set value(b){e=b,a.setParameter("contrast",b)}},exposure:{max:10,min:-10,step:.1,ui:"slider",get value(){return f},set value(b){f=b,a.setParameter("exposure",b)}},gamma:{max:3,min:0,step:.1,ui:"slider",get value(){return g},set value(b){g=b,a.setParameter("gamma",b)}},saturation:{max:10,min:0,step:.1,ui:"slider",get value(){return h},set value(b){h=b,a.setParameter("saturation",b)}}},this.reset()};return e.prototype=new d,e.prototype.reset=function(){this.parameters.brightness.value=0,this.parameters.exposure.value=0,this.parameters.contrast.value=1,this.parameters.saturation.value=1,this.parameters.gamma.value=1},e.prototype.constructor=e,d.export("buildin.coloradjust",e),e}),d("shaders/hue.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform float hueAdjust;\n\nconst vec4 kRGBToYPrime = vec4 (0.299, 0.587, 0.114, 0.0);\nconst vec4 kRGBToI     = vec4 (0.595716, -0.274453, -0.321263, 0.0);\nconst vec4 kRGBToQ     = vec4 (0.211456, -0.522591, 0.31135, 0.0);\n \nconst vec4 kYIQToR   = vec4 (1.0, 0.9563, 0.6210, 0.0);\nconst vec4 kYIQToG   = vec4 (1.0, -0.2721, -0.6474, 0.0);\nconst vec4 kYIQToB   = vec4 (1.0, -1.1070, 1.7046, 0.0);\n \n\n\n void main ()\n {\n     // Sample the input pixel\n    vec4 color   = texture2D(texture, v_Texcoord);\n     \n     // Convert to YIQ\n    float YPrime  = dot (color, kRGBToYPrime);\n    float I      = dot (color, kRGBToI);\n    float Q      = dot (color, kRGBToQ);\n     \n     // Calculate the hue and chroma\n    float hue     = atan (Q, I);\n    float chroma  = sqrt (I * I + Q * Q);\n     \n    // Make the user's adjustments\n    hue += (-hueAdjust); //why negative rotation?\n     \n    // Convert back to YIQ\n    Q = chroma * sin (hue);\n    I = chroma * cos (hue);\n     \n     // Convert back to RGB\n    vec4 yIQ = vec4 (YPrime, I, Q, 0.0);\n    color.r = dot (yIQ, kYIQToR);\n    color.g = dot (yIQ, kYIQToG);\n    color.b = dot (yIQ, kYIQToB);\n     \n    // Save the result\n    gl_FragColor = color;\n }"}),d("src/buildin/hue",["require","qtek","../fx","shaders/hue.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/hue.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b;var e=0;this.parameters={hue:{max:180,min:-180,precision:1,ui:"slider",get value(){return e},set value(a){e=a,b.setParameter("hueAdjust",a/180*Math.PI)}}},this.reset()};return e.prototype=new d,e.prototype.constructor=e,e.prototype.reset=function(){this.parameters.hue.value=0},d.export("buildin.hue",e),e}),d("shaders/colormatrix.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nuniform mat4 colorMatrix;\nuniform float intensity : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec4 outputColor = tex * colorMatrix;\n\n    gl_FragColor = intensity * outputColor + ( (1.0-intensity) * tex );\n}"}),d("src/buildin/colormatrix",["require","qtek","../fx","shaders/colormatrix.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/colormatrix.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b;var e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),f=1;this.parameters={colorMatrix:{get value(){return e},set value(a){e=a,b.setParameter("colorMatrix",a)}},intensity:{min:0,max:1,ui:"slider",step:.01,get intensity(){return f},set intensity(a){f=a,b.setParameter("intensity",a)}}}};return e.prototype=new d,e.prototype.constructor=e,d.export("buildin.colormatrix",e),e}),d("src/buildin/sepia",["require","qtek","./colormatrix","../fx"],function(a){var b=a("qtek");b["3d"];var c=a("./colormatrix"),d=a("../fx"),e=function(){c.call(this),this.parameters.colorMatrix.value=new Float32Array([.3588,.7044,.1368,0,.299,.587,.114,0,.2392,.4696,.0912,0,0,0,0,1])};return e.prototype=new c,e.prototype.constructor=e,d.export("buildin.sepia",e),e}),d("shaders/lut.essl",[],function(){return"varying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform sampler2D lookup;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    float blueColor = tex.b * 63.0;\n    \n    vec2 quad1;\n    quad1.y = floor(floor(blueColor) / 8.0);\n    quad1.x = floor(blueColor) - (quad1.y * 8.0);\n    \n    vec2 quad2;\n    quad2.y = floor(ceil(blueColor) / 8.0);\n    quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n    \n    vec2 texPos1;\n    texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec2 texPos2;\n    texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec4 newColor1 = texture2D(lookup, texPos1);\n    vec4 newColor2 = texture2D(lookup, texPos2);\n    \n    vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n    gl_FragColor = vec4(newColor.rgb, tex.w);\n}"}),d("src/buildin/lut",["require","qtek","../fx","shaders/lut.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/lut.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b;var e=new c.texture.Texture2D({minFilter:"NEAREST",magFilter:"NEAREST",generateMipmaps:!1,flipY:!1});b.setParameter("lookup",e),this.parameters={lookup:{get value(){return e.image},set value(a){e.image=a,e.dirty()}}}};return e.prototype=new d,e.prototype.constructor=e,d.export("buildin.lut",e),e}),d("shaders/sobel.essl",[],function(){return"// Sobel edge detection\n// http://en.wikipedia.org/wiki/Sobel_operator\n//\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth : 512;\nuniform float imageHeight : 512;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n	vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n\n	// top left\n	float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n	// top\n	float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n	// top right\n	float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n	// left\n	float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n	// center\n	float center = luminance( texture2D( texture, v_Texcoord) );\n	// right\n	float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n	// bottom left\n	float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n	// bottom\n	float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n	// bottom right\n	float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n	float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n	float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n	float mag = length(vec2(h,v));\n	gl_FragColor = vec4(vec3(mag), 1.0);\n}"}),d("src/buildin/sobel",["require","qtek","../fx","shaders/sobel.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/sobel.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b};return e.prototype=new d,e.prototype.constructor=e,d.export("buildin.sobel",e),e}),d("shaders/sketch.essl",[],function(){return"varying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth : 512;\nuniform float imageHeight : 512;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n	vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n\n	// top left\n	float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n	// top\n	float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n	// top right\n	float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n	// left\n	float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n	// center\n	float center = luminance( texture2D( texture, v_Texcoord) );\n	// right\n	float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n	// bottom left\n	float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n	// bottom\n	float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n	// bottom right\n	float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n	float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n	float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n	float mag = 1.0 - length(vec2(h, v));\n\n	gl_FragColor = vec4(vec3(mag), 1.0);\n}"}),d("src/buildin/sketch",["require","qtek","../fx","shaders/sketch.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/sketch.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b};return e.prototype=new d,e.prototype.constructor=e,d.export("buildin.sketch",e),e}),d("shaders/toon.essl",[],function(){return"varying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float imageWidth;\nuniform float imageHeight;\n\nuniform float threshold : 0.2;\nuniform float quantizationLevels : 10;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nfloat luminance(vec4 color){\n    return dot(color.rgb, w);\n}\n\nvoid main(){\n\n    vec2 offset = vec2(1.0/imageWidth, 1.0/imageHeight);\n    vec4 tex = texture2D(texture, v_Texcoord);\n    // top left\n    float topLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, -offset.y)) );\n    // top\n    float top = luminance( texture2D(texture, v_Texcoord+vec2(0, -offset.y)) );\n    // top right\n    float topRight = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, -offset.y)) );\n    // left\n    float left = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, 0)) );\n    // center\n    float center = luminance( texture2D( texture, v_Texcoord) );\n    // right\n    float right = luminance( texture2D(texture, v_Texcoord+vec2(offset.x, 0)) );\n    // bottom left\n    float bottomLeft = luminance( texture2D(texture, v_Texcoord+vec2(-offset.x, offset.y)) );\n    // bottom\n    float bottom = luminance( texture2D(texture, v_Texcoord+vec2(0, offset.y)) );\n    // bottom right\n    float bottomRight = luminance( texture2D(texture, v_Texcoord+offset) );\n\n    float h = -topLeft-2.0*top-topRight+bottomLeft+2.0*bottom+bottomRight;\n    float v = -bottomLeft-2.0*left-topLeft+bottomRight+2.0*right+topRight;\n\n    float mag = length(vec2(h, v));\n    \n    vec3 posterizedImageColor = floor((tex.rgb * quantizationLevels) + 0.5) / quantizationLevels;\n    float thresholdTest = 1.0 - step(threshold, mag);\n    \n    gl_FragColor = vec4(posterizedImageColor * thresholdTest, tex.a);\n}"}),d("src/buildin/toon",["require","qtek","../fx","shaders/toon.essl"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var b=new c.compositor.Node({shader:a("shaders/toon.essl"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=b;var e=.2,f=10;this.parameters={threshold:{ui:"slider",min:0,max:2,get value(){return e},set value(a){e=a,b.setParameter("threshold",a)}},quantizationLevels:{ui:"spinner",min:2,precision:0,get value(){return f},set value(a){f=a,b.setParameter("quantizationLevels",a)}}}};return e.prototype=new d,e.prototype.constructor=e,e.prototype.reset=function(){this.parameters.threshold.value=.2,this.parameters.quantizationLevels.value=10},d.export("buildin.toon",e),e}),d("src/buildin/grayscale",["require","qtek","../fx"],function(a){var b=a("qtek"),c=b["3d"],d=a("../fx"),e=function(){d.call(this);var a=new c.compositor.Node({shader:c.Shader.source("buildin.compositor.grayscale"),inputs:{texture:{node:null,pin:"color"}},outputs:{color:{}}});this.node=a};return e.prototype=new d,e.prototype.constructor=e,d.export("buildin.grayscale",e),e}),d("src/layer",["require","qtek","./fx","./buildin/gaussian","./buildin/lensblur","./buildin/boxblur","./buildin/coloradjust","./buildin/hue","./buildin/colormatrix","./buildin/sepia","./buildin/lut","./buildin/sobel","./buildin/sketch","./buildin/toon","./buildin/grayscale"],function(a){a("qtek");var b=a("./fx"),c=function(a){this.fx=null,this.enabled=!0,this.prevSibling=null,this.nextSibling=null,this._fxCaches={},a&&this.use(a)};return c.prototype.use=function(a){var c=this._fxCaches[a];return c?c.reset():c=b.create(a),c?(c.input=this.prevSibling,this._fxCaches[a]=c,this.fx=c,c):void 0},c.prototype.set=function(a,b){if(a)if("object"!=typeof a)this.fx&&this.fx.parameters[a]&&(this.fx.parameters[a].value=b);else{var c=a;for(var a in c)this.set(a,c[a])}},a("./buildin/gaussian"),a("./buildin/lensblur"),a("./buildin/boxblur"),a("./buildin/coloradjust"),a("./buildin/hue"),a("./buildin/colormatrix"),a("./buildin/sepia"),a("./buildin/lut"),a("./buildin/sobel"),a("./buildin/sketch"),a("./buildin/toon"),a("./buildin/grayscale"),c}),d("src/processor",["require","qtek","./layer","./fx"],function(a){var b=a("qtek"),c=b["3d"];a("./layer"),a("./fx");var d=function(a,b){this.canvas=a||document.createElement("canvas"),this.renderer=new c.Renderer({canvas:this.canvas,devicePixelRatio:1}),this.scale=1,this.compositor=new c.Compositor,this.layers=[],this._inputNode=new c.compositor.TextureNode({texture:new c.texture.Texture2D({image:null}),outputs:{color:{parameters:{width:1024,height:1024,wrapS:"REPEAT",wrapT:"REPEAT"}}}}),this._outputNode=new c.compositor.Node({shader:c.Shader.source("buildin.compositor.output"),inputs:{texture:{node:null,pin:"color"}}}),this._imageChanged=!0,Object.defineProperty(this,"image",{set:function(a){this._inputNode.texture.image=a,this._inputNode.texture.dirty(),this._imageChanged=!0},get:function(){return this._inputNode.texture.image}}),this.image=b||null};return d.prototype.add=function(a){this.layers.push(a)},d.prototype.remove=function(a){var b=this.layers.indexOf(a);this.layers.splice(b,1)},d.prototype.update=function(){for(var a=[],b=0;b<this.layers.length;b++){var c=this.layers[b];c.enabled&&c.fx&&a.push(this.layers[b])}for(var b=0;b<a.length;b++){var c=a[b],d=a[b-1]||null,e=a[b+1]||null;c.prevSibling=d,c.nextSibling=e,d&&(c.fx.input=d.fx.node)}a.length?(this._outputNode.inputs.texture.node=a[a.length-1].fx.node,a[0].fx.input=this._inputNode):this._outputNode.inputs.texture.node=this._inputNode;var f=this.image.width*this.scale,g=this.image.height*this.scale;this._imageChanged&&this.renderer.resize(f,g),this.compositor.nodes=[];for(var b=0;b<a.length;b++)this.compositor.add(a[b].fx.node),this._imageChanged&&a[b].fx.setImageSize(f,g);this._inputNode.outputs.color.parameters={width:f,height:g},this.compositor.add(this._inputNode),this.compositor.add(this._outputNode),this.compositor.render(this.renderer)},d}),d("shaders/histogram.essl",[],function(){return"//Red channel\n@export emage.histogram_r.vertex\n\nattribute vec4 position;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(1.0, 0.0, 0.0);\n    gl_Position = vec4(-1.0 + position.x * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Grenn channel\n@export emage.histogram_g.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(0.0, 1.0, 0.0);\n    gl_Position = vec4(-1.0 + position.y * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Blue channel\n@export emage.histogram_b.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    colorFactor = vec3(0.0, 0.0, 1.0);\n    gl_Position = vec4(-1.0 + position.z * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n//Luminance channel\n@export emage.histogram_l.vertex\n\nattribute vec4 position : POSITION;\n\nvarying lowp vec3 colorFactor;\nconst highp vec3 W = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    colorFactor = vec3(1.0, 1.0, 1.0);\n    gl_Position = vec4(-1.0 + dot(position.xyz, W) * 0.0078125, 0.0, 0.0, 1.0);\n    gl_PointSize = 1.0;\n}\n\n@end\n\n@export emage.histogram.fragment\n\nconst lowp float scalingFactor = 1.0 / 256.0;\n\nvarying lowp vec3 colorFactor;\n\nvoid main()\n{\n    gl_FragColor = vec4(colorFactor * scalingFactor, 1.0);\n}\n\n@end\n\n"}),d("src/histogram",["require","qtek","shaders/histogram.essl"],function(a){var b=a("qtek"),c=b["3d"],d=c.Shader,e={height:1,width:256,minFilter:"NEAREST",magFilter:"NEAREST",generateMipmaps:!1},f=document.createElement("canvas"),g=f.getContext("2d");d.import(a("shaders/histogram.essl"));var h=function(a){this.downSample=1/8,this.image=a,this.canvas=document.createElement("canvas"),this.renderer=new c.Renderer({canvas:this.canvas,preserveDrawingBuffer:!0}),this.channels={red:new Uint8Array(256),green:new Uint8Array(256),blue:new Uint8Array(256),luminance:new Uint8Array(256)},this._pixels={red:new Uint8Array(1024),green:new Uint8Array(1024),blue:new Uint8Array(1024),luminance:new Uint8Array(1024)};var b=this.renderer.gl;b.enableVertexAttribArray(0),this._framBuffer=new c.FrameBuffer({depthBuffer:!1}),this._textureRed=new c.texture.Texture2D(e),this._textureBlue=new c.texture.Texture2D(e),this._textureGreen=new c.texture.Texture2D(e),this._textureLuminance=new c.texture.Texture2D(e),this._shaderRed=new c.Shader({vertex:d.source("emage.histogram_r.vertex"),fragment:d.source("emage.histogram.fragment")}),this._shaderGreen=new c.Shader({vertex:d.source("emage.histogram_g.vertex"),fragment:d.source("emage.histogram.fragment")}),this._shaderBlue=new c.Shader({vertex:d.source("emage.histogram_b.vertex"),fragment:d.source("emage.histogram.fragment")}),this._shaderLuminance=new c.Shader({vertex:d.source("emage.histogram_l.vertex"),fragment:d.source("emage.histogram.fragment")}),this._buffer=b.createBuffer(),this._imageChanged=!0};return h.prototype.update=function(){var a=this.renderer.gl,b=this.image;f.width=b.width*this.downSample,f.height=b.height*this.downSample,g.drawImage(b,0,0,f.width,f.height);var c=g.getImageData(0,0,f.width,f.height);a.bindBuffer(a.ARRAY_BUFFER,this._buffer),a.bufferData(a.ARRAY_BUFFER,c.data,a.STATIC_DRAW),a.vertexAttribPointer(0,4,a.UNSIGNED_BYTE,!1,0,0),a.clearColor(0,0,0,1),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ONE),a.enable(a.BLEND),a.disable(a.DEPTH_TEST);var d=c.width,e=c.height,h=d*e;a.clear(a.COLOR_BUFFER_BIT),this._shaderRed.bind(a),this._framBuffer.attach(a,this._textureRed),this._framBuffer.bind(this.renderer),a.drawArrays(a.POINT,0,h),a.readPixels(0,0,256,1,a.RGBA,a.UNSIGNED_BYTE,this._pixels.red),a.clear(a.COLOR_BUFFER_BIT),this._shaderGreen.bind(a),this._framBuffer.attach(a,this._textureGreen),this._framBuffer.bind(this.renderer),a.drawArrays(a.POINT,0,h),a.readPixels(0,0,256,1,a.RGBA,a.UNSIGNED_BYTE,this._pixels.green),a.clear(a.COLOR_BUFFER_BIT),this._shaderBlue.bind(a),this._framBuffer.attach(a,this._textureBlue),this._framBuffer.bind(this.renderer),a.drawArrays(a.POINT,0,h),a.readPixels(0,0,256,1,a.RGBA,a.UNSIGNED_BYTE,this._pixels.blue),a.clear(a.COLOR_BUFFER_BIT),this._shaderLuminance.bind(a),this._framBuffer.attach(a,this._textureLuminance),this._framBuffer.bind(this.renderer),a.drawArrays(a.POINT,0,h),a.readPixels(0,0,256,1,a.RGBA,a.UNSIGNED_BYTE,this._pixels.luminance);for(var i=0;256>i;i++)this.channels.red[i]=this._pixels.red[4*i],this.channels.green[i]=this._pixels.green[4*i+1],this.channels.blue[i]=this._pixels.blue[4*i+2],this.channels.luminance[i]=this._pixels.luminance[4*i];a.disable(a.BLEND),a.enable(a.DEPTH_TEST),document.body.appendChild(this.canvas)},h.prototype.draw=function(){},h.prototype.get=function(){},h}),d("src/emage",["require","./fx","./layer","./processor","./histogram","qtek"],function(a){var b={FX:a("./fx"),Layer:a("./layer"),Processor:a("./processor"),Histogram:a("./histogram"),qtek:a("qtek")};return b});var e=c("src/emage");for(var f in e)a[f]=e[f]});